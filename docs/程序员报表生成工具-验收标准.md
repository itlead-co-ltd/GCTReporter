# 程序员报表生成工具 - 验收标准文档

> **文档类型**: Must Have用户故事验收标准（Acceptance Criteria）
> **生成日期**: 2025-12-26
> **来源文档**: 程序员报表生成工具-Must-Have故事.md
> **适用范围**: 30个Must Have故事
> **编写规范**: Given-When-Then (GWT) 格式

---

## 📋 文档说明

本文档为每个Must Have用户故事提供详细的验收标准，包括：

- ✅ **功能验收**: 验证功能正确性
- 📊 **数据验收**: 验证数据正确性
- 🖥️ **界面验收**: 验证界面元素和交互
- ⚡ **性能验收**: 验证性能指标
- 🔒 **安全验收**: 验证安全要求

**验收标准格式**: Given-When-Then (GWT)
- **Given**: 前置条件（系统状态、用户状态、数据状态）
- **When**: 用户操作（触发行为的具体步骤）
- **Then**: 预期结果（系统响应、状态变化、显示内容）

---

## 🏗️ 功能分组1：基础设施层

### US001: 用户登录功能

#### 用户故事
> 作为 系统用户，
> 我希望 能够通过用户名和密码登录系统，
> 以便 访问系统功能。

---

#### 验收标准

##### AC1: 正常登录流程

**场景描述**: 用户使用正确的用户名和密码成功登录系统

**Given** 前置条件
- 用户在登录页面
- 用户名为"admin"，密码为"admin123"的账号已存在且状态为"启用"
- 用户未登录（Session中无用户信息）

**When** 用户操作
- 在用户名输入框输入"admin"
- 在密码输入框输入"admin123"
- 点击"登录"按钮

**Then** 预期结果
- 系统验证用户名和密码正确
- 创建Session，存储用户信息（用户ID、用户名、角色）
- 跳转到系统首页（/home）
- 首页显示用户名和"退出登录"按钮

---

##### AC2: 用户名或密码错误

**场景描述**: 用户输入错误的用户名或密码时，系统拒绝登录并提示错误

**Given** 前置条件
- 用户在登录页面
- 用户名为"admin"的账号存在，密码为"admin123"

**When** 用户操作
- 在用户名输入框输入"admin"
- 在密码输入框输入"wrongpassword"（错误密码）
- 点击"登录"按钮

**Then** 预期结果
- 系统验证失败
- 停留在登录页面
- 显示错误提示："用户名或密码错误"（红色文字）
- 输入框内容不清空（保留用户名）
- 密码输入框内容清空

---

##### AC3: 用户名或密码为空

**场景描述**: 用户未填写用户名或密码时，系统拒绝登录并提示错误

**Given** 前置条件
- 用户在登录页面

**When** 用户操作（场景A：用户名为空）
- 用户名输入框为空
- 在密码输入框输入"admin123"
- 点击"登录"按钮

**Then** 预期结果
- 系统前端校验失败
- 停留在登录页面
- 用户名输入框显示红色边框
- 显示错误提示："用户名不能为空"（在输入框下方）
- 不发送登录请求到后端

**When** 用户操作（场景B：密码为空）
- 在用户名输入框输入"admin"
- 密码输入框为空
- 点击"登录"按钮

**Then** 预期结果
- 系统前端校验失败
- 停留在登录页面
- 密码输入框显示红色边框
- 显示错误提示："密码不能为空"
- 不发送登录请求到后端

---

##### AC4: 禁用用户登录

**场景描述**: 禁用状态的用户无法登录系统

**Given** 前置条件
- 用户在登录页面
- 用户名为"disabled_user"的账号存在，状态为"禁用"（enabled=false）

**When** 用户操作
- 在用户名输入框输入"disabled_user"
- 在密码输入框输入正确密码
- 点击"登录"按钮

**Then** 预期结果
- 系统验证用户状态为"禁用"
- 拒绝登录
- 停留在登录页面
- 显示错误提示："该账号已被禁用，请联系管理员"
- 不创建Session

---

#### 边界条件

| 边界场景 | 输入条件 | 预期行为 |
|---------|---------|---------|
| 用户名长度上限 | 输入超过50个字符的用户名 | 前端限制输入，最多50字符 |
| 密码长度上限 | 输入超过100个字符的密码 | 前端限制输入，最多100字符 |
| 用户名包含特殊字符 | 输入"admin@#$" | 允许输入，后端验证失败提示"用户名或密码错误" |
| 连续登录失败3次 | 输入错误密码3次 | （可选功能）账号锁定5分钟，提示"登录失败次数过多，账号已锁定5分钟" |
| Session已存在 | 用户已登录，再次访问登录页 | 自动跳转到首页，不显示登录页 |

---

#### 性能要求

| 性能指标 | 要求 | 测试方法 |
|---------|------|---------|
| 登录响应时间 | <2秒（P95） | 使用JMeter测试，50并发用户同时登录 |
| 并发登录 | 支持100并发用户同时登录 | 压力测试，100用户并发登录，成功率>95% |
| Session创建时间 | <100ms | 后端单元测试，测量Session创建耗时 |

---

#### 界面要求

**必要元素**:
- Logo和系统标题（"程序员报表生成工具"）
- 用户名输入框（placeholder: "请输入用户名"）
- 密码输入框（placeholder: "请输入密码"，type=password）
- "登录"按钮（主按钮样式，蓝色）
- 错误提示区域（动态显示，红色文字）

**交互行为**:
- 点击"登录"按钮后，按钮变为禁用状态（防止重复提交）
- 显示加载动画（按钮文字变为"登录中..."）
- 登录成功后无闪烁，平滑跳转到首页
- 登录失败后恢复按钮状态，可重新输入

**响应式要求**:
- 支持桌面浏览器（1920x1080、1366x768）
- 登录表单居中显示，宽度固定400px
- 移动端（可选）：表单宽度自适应，左右边距20px

---

#### 测试建议

**测试类型**: 功能测试 + E2E测试
**测试数据**: 
- 正常账号：admin/admin123（ADMIN角色）、designer/designer123（DESIGNER角色）
- 禁用账号：disabled_user/password123
- 不存在账号：nonexist/password

**自动化建议**: 高优先级，核心功能，建议使用Selenium或Cypress编写E2E自动化测试

---

### US002: 用户登出功能

#### 用户故事
> 作为 系统用户，
> 我希望 能够安全地退出系统，
> 以便 保护我的账号信息。

---

#### 验收标准

##### AC1: 正常登出流程

**场景描述**: 已登录用户点击"退出登录"按钮，成功退出系统

**Given** 前置条件
- 用户已登录系统（Session中有用户信息）
- 用户在系统首页或任意功能页面
- 页面右上角显示用户名和"退出登录"按钮

**When** 用户操作
- 点击右上角的"退出登录"按钮

**Then** 预期结果
- 系统清除Session（删除Session中的用户信息）
- Session立即失效
- 跳转到登录页面（/login）
- 登录页面显示空白输入框（不保留任何信息）
- 用户无法通过浏览器"后退"按钮返回功能页面

---

##### AC2: 登出后Session失效验证

**场景描述**: 用户登出后，尝试直接访问功能页面时，系统拒绝访问

**Given** 前置条件
- 用户已成功登出系统
- Session已清除

**When** 用户操作
- 在浏览器地址栏输入功能页面URL（如 /reports）
- 按回车访问

**Then** 预期结果
- 系统拦截器检测到Session无效
- 拒绝访问功能页面
- 自动跳转到登录页面
- 显示提示："请先登录"（可选）

---

##### AC3: 未登录用户无"退出登录"按钮

**场景描述**: 未登录状态下，页面不显示"退出登录"按钮

**Given** 前置条件
- 用户未登录系统
- 用户在登录页面

**When** 用户操作
- 观察页面布局

**Then** 预期结果
- 页面右上角不显示用户名
- 页面右上角不显示"退出登录"按钮
- 只显示登录表单

---

#### 边界条件

| 边界场景 | 输入条件 | 预期行为 |
|---------|---------|---------|
| 重复点击"退出登录" | 快速连续点击"退出登录"按钮2次 | 第一次点击生效，第二次点击时已跳转到登录页，无影响 |
| Session超时后登出 | Session已超时（30分钟无操作），再点击"退出登录" | 直接跳转到登录页面，提示"Session已过期" |
| 多标签页同时登出 | 打开2个浏览器标签页，在其中一个登出 | 另一个标签页下次操作时检测到Session无效，自动跳转到登录页 |

---

#### 性能要求

| 性能指标 | 要求 | 测试方法 |
|---------|------|---------|
| 登出响应时间 | <1秒 | 点击"退出登录"到跳转到登录页的时间 |
| Session清除时间 | <100ms | 后端测量Session清除操作耗时 |

---

#### 界面要求

**必要元素**:
- "退出登录"按钮（位于页面右上角）
- 按钮显示用户名（如"admin"）旁边
- 按钮样式：普通按钮或文字链接

**交互行为**:
- 点击"退出登录"后无确认对话框（直接退出）
- 页面无闪烁，平滑跳转到登录页
- 跳转动画时长<300ms

**响应式要求**:
- 桌面端："退出登录"按钮在右上角，用户名左侧
- 移动端（可选）："退出登录"在下拉菜单中

---

#### 测试建议

**测试类型**: 功能测试 + E2E测试
**测试数据**: 使用任意已登录账号（admin/designer/viewer）
**自动化建议**: 中优先级，建议编写E2E测试覆盖登出流程

---

### US003: Session管理与认证拦截器

#### 用户故事
> 作为 系统开发者，
> 我希望 实现Session管理和认证拦截器，
> 以便 确保只有登录用户才能访问系统功能。

---

#### 验收标准

##### AC1: 未登录用户访问功能页面被拦截

**场景描述**: 未登录用户尝试直接访问功能页面时，系统拦截并跳转到登录页

**Given** 前置条件
- 用户未登录系统（Session中无用户信息）
- 系统拦截器已配置并启用

**When** 用户操作
- 在浏览器地址栏输入功能页面URL（如 /reports、/users、/admin）
- 按回车访问

**Then** 预期结果
- 拦截器检测到Session无效
- 拒绝访问功能页面
- 自动跳转到登录页面（/login）
- 不显示功能页面的任何内容
- 后端日志记录拦截事件（用户IP、请求URL、拦截时间）

---

##### AC2: 登录页和静态资源不被拦截

**场景描述**: 登录页、静态资源（CSS/JS/图片）不需要登录即可访问

**Given** 前置条件
- 用户未登录系统
- 拦截器配置白名单路径：/login, /static/**, /favicon.ico

**When** 用户操作（场景A：访问登录页）
- 在浏览器输入登录页URL（/login）

**Then** 预期结果
- 拦截器放行请求（不拦截）
- 正常显示登录页面
- 登录页面的CSS/JS正常加载

**When** 用户操作（场景B：访问静态资源）
- 浏览器请求静态资源（如 /static/css/style.css）

**Then** 预期结果
- 拦截器放行请求
- 静态资源正常返回
- 响应状态码200

---

##### AC3: Session超时自动跳转

**场景描述**: 用户登录后30分钟无操作，Session自动过期，下次操作时跳转到登录页

**Given** 前置条件
- 用户已登录系统（Session创建时间为T0）
- Session超时时间配置为30分钟
- 用户在T0+31分钟时进行操作（Session已过期）

**When** 用户操作
- 点击任意功能按钮（如"查看报表列表"）

**Then** 预期结果
- 拦截器检测到Session已过期（超过30分钟）
- 清除过期Session
- 拦截请求，跳转到登录页面
- 显示提示："登录已过期，请重新登录"
- 用户需要重新输入用户名和密码

---

##### AC4: 已登录用户正常访问功能页面

**场景描述**: 已登录用户访问功能页面时，拦截器放行

**Given** 前置条件
- 用户已登录系统（Session有效）
- Session中存储用户信息（用户ID、用户名、角色）

**When** 用户操作
- 点击导航菜单，访问功能页面（如"报表列表"）
- 浏览器请求 /reports

**Then** 预期结果
- 拦截器检测到Session有效
- 放行请求，允许访问功能页面
- 功能页面正常显示
- 页面右上角显示用户名和"退出登录"按钮
- 后端从Session中获取用户信息，用于业务逻辑

---

#### 边界条件

| 边界场景 | 输入条件 | 预期行为 |
|---------|---------|---------|
| API请求被拦截 | 前端AJAX请求功能API（如 /api/reports），Session无效 | 拦截器返回401未授权状态码，前端显示"请先登录" |
| 跨域请求拦截 | 第三方网站请求系统API（CORS跨域） | 拦截器拒绝跨域请求，返回403错误 |
| Session ID伪造 | 伪造Session ID Cookie | 拦截器验证Session无效，跳转到登录页 |
| 多用户同时登录 | 100个用户同时登录并访问功能页面 | 拦截器正常处理，每个用户独立Session，无干扰 |

---

#### 性能要求

| 性能指标 | 要求 | 测试方法 |
|---------|------|---------|
| 拦截器处理时间 | <10ms | 后端单元测试，测量拦截器preHandle方法耗时 |
| Session查询时间 | <5ms | 测量从Session获取用户信息的耗时 |
| 并发处理能力 | 支持100并发请求 | JMeter压力测试，100并发请求，拦截器正常工作 |

---

#### 技术要求

**必要实现**:
- SpringBoot HandlerInterceptor实现
- Session管理：HttpSession或Spring Session
- 白名单路径配置：/login, /static/**, /favicon.ico
- Session超时配置：30分钟（可配置）
- 拦截所有请求，除白名单路径

**技术要点**:
```java
// 拦截器伪代码示例
public class AuthInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, 
                             HttpServletResponse response, 
                             Object handler) {
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            response.sendRedirect("/login");
            return false; // 拦截请求
        }
        return true; // 放行请求
    }
}
```

---

#### 测试建议

**测试类型**: 集成测试 + 单元测试
**测试数据**: 
- 有效Session：登录后创建的Session
- 无效Session：未登录、Session过期、伪造Session ID

**测试场景**:
1. 未登录访问功能页面 → 跳转到登录页
2. 登录后访问功能页面 → 正常访问
3. Session超时后访问 → 跳转到登录页
4. 访问白名单路径 → 不拦截

**自动化建议**: 高优先级，核心安全功能，必须编写集成测试

---

### US004: 数据库表结构初始化

#### 用户故事
> 作为 系统开发者，
> 我希望 初始化数据库表结构（用户、报表、参数、列配置、权限、日志），
> 以便 系统能够正常运行。

---

#### 验收标准

##### AC1: 数据库表结构创建成功

**场景描述**: 执行初始化脚本后，所有必需的数据库表创建成功

**Given** 前置条件
- MySQL数据库已安装并启动
- 数据库名称为"report_system"（或配置的数据库名）
- 数据库为空（无任何表）
- 初始化脚本文件存在（schema.sql）

**When** 系统操作
- SpringBoot应用启动
- Flyway或Liquibase执行数据库迁移脚本
- 执行schema.sql创建表结构

**Then** 预期结果
- 创建6个核心表：
  - users（用户表）
  - reports（报表表）
  - report_params（参数表）
  - report_columns（列配置表）
  - report_permissions（权限表）
  - execution_logs（执行日志表）
- 每个表的字段定义正确（名称、类型、长度、约束）
- 表创建成功，无SQL执行错误
- 数据库迁移版本记录到flyway_schema_history表

---

##### AC2: 表结构字段验证

**场景描述**: 验证每个表包含必要的字段和约束

**Given** 前置条件
- 数据库表已创建成功

**When** 验证操作
- 查询表结构（DESCRIBE users）

**Then** 预期结果（users表）
- ✅ id（BIGINT, PRIMARY KEY, AUTO_INCREMENT）
- ✅ username（VARCHAR(50), UNIQUE, NOT NULL）
- ✅ password（VARCHAR(100), NOT NULL）- 加密后的密码
- ✅ role（VARCHAR(20), NOT NULL）- ADMIN/DESIGNER/VIEWER
- ✅ enabled（BOOLEAN, DEFAULT TRUE）- 用户状态
- ✅ created_at（DATETIME, NOT NULL）
- ✅ updated_at（DATETIME, NOT NULL）
- ✅ deleted（BOOLEAN, DEFAULT FALSE）- 软删除标记

**Then** 预期结果（reports表）
- ✅ id（BIGINT, PRIMARY KEY, AUTO_INCREMENT）
- ✅ name（VARCHAR(100), UNIQUE, NOT NULL）
- ✅ description（TEXT）
- ✅ sql_content（TEXT, NOT NULL）
- ✅ creator_id（BIGINT, FOREIGN KEY → users.id）
- ✅ status（VARCHAR(20), DEFAULT 'DRAFT'）
- ✅ created_at（DATETIME, NOT NULL）
- ✅ updated_at（DATETIME, NOT NULL）
- ✅ deleted（BOOLEAN, DEFAULT FALSE）

**Then** 预期结果（report_params表）
- ✅ id（BIGINT, PRIMARY KEY, AUTO_INCREMENT）
- ✅ report_id（BIGINT, FOREIGN KEY → reports.id）
- ✅ param_name（VARCHAR(50), NOT NULL）
- ✅ param_type（VARCHAR(20), NOT NULL）- STRING/NUMBER/DATE/DATETIME
- ✅ default_value（VARCHAR(200）
- ✅ required（BOOLEAN, DEFAULT FALSE）
- ✅ description（VARCHAR(200）
- ✅ sort_order（INT, DEFAULT 0）

**Then** 预期结果（report_columns表）
- ✅ id（BIGINT, PRIMARY KEY, AUTO_INCREMENT）
- ✅ report_id（BIGINT, FOREIGN KEY → reports.id）
- ✅ field_name（VARCHAR(50), NOT NULL）
- ✅ display_name（VARCHAR(100）
- ✅ column_width（INT, DEFAULT 100）
- ✅ format_type（VARCHAR(20), DEFAULT 'DEFAULT'）
- ✅ visible（BOOLEAN, DEFAULT TRUE）
- ✅ sort_order（INT, DEFAULT 0）

**Then** 预期结果（report_permissions表）
- ✅ id（BIGINT, PRIMARY KEY, AUTO_INCREMENT）
- ✅ report_id（BIGINT, FOREIGN KEY → reports.id）
- ✅ role（VARCHAR(20), NOT NULL）
- ✅ created_at（DATETIME, NOT NULL）

**Then** 预期结果（execution_logs表）
- ✅ id（BIGINT, PRIMARY KEY, AUTO_INCREMENT）
- ✅ user_id（BIGINT, FOREIGN KEY → users.id）
- ✅ report_id（BIGINT, FOREIGN KEY → reports.id）
- ✅ params_json（TEXT）
- ✅ execute_time（DATETIME, NOT NULL）
- ✅ result_count（INT）
- ✅ success（BOOLEAN, NOT NULL）
- ✅ error_message（TEXT）

---

##### AC3: 初始化数据创建成功

**场景描述**: 执行初始化脚本后，创建默认管理员账号和角色数据

**Given** 前置条件
- 数据库表结构已创建
- 初始化数据脚本存在（data.sql）

**When** 系统操作
- 执行data.sql插入初始数据

**Then** 预期结果
- 创建默认管理员账号：
  - username: admin
  - password: $2a$10$... （BCrypt加密后的"admin123"）
  - role: ADMIN
  - enabled: TRUE
- 验证数据：SELECT * FROM users WHERE username='admin'
- 返回1条记录，密码已加密，角色为ADMIN

---

##### AC4: 外键约束验证

**场景描述**: 验证外键约束生效，防止数据不一致

**Given** 前置条件
- 数据库表已创建，外键约束已定义

**When** 验证操作
- 尝试插入report_params记录，report_id指向不存在的报表ID（如999999）

**Then** 预期结果
- 插入失败
- 数据库返回外键约束错误（Foreign key constraint fails）
- report_params表中无脏数据

---

#### 边界条件

| 边界场景 | 输入条件 | 预期行为 |
|---------|---------|---------|
| 重复执行初始化脚本 | 数据库表已存在，再次执行schema.sql | Flyway检测到版本已存在，跳过执行，不报错 |
| 数据库不存在 | 配置的数据库名不存在 | SpringBoot启动失败，显示数据库连接错误 |
| 字段长度上限 | username插入超过50字符 | 数据库拒绝插入，返回"Data too long for column"错误 |
| 唯一约束验证 | 插入重复username | 数据库拒绝插入，返回"Duplicate entry"错误 |

---

#### 技术要求

**必要实现**:
- 使用Flyway或Liquibase管理数据库版本
- schema.sql：创建表结构
- data.sql：插入初始数据
- 所有表支持软删除（deleted字段）
- 所有表包含created_at和updated_at字段
- 外键约束：report_params/report_columns/report_permissions → reports
- 索引：username唯一索引、report_id索引

**技术要点**:
```sql
-- users表创建示例
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(100) NOT NULL,
    role VARCHAR(20) NOT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted BOOLEAN DEFAULT FALSE,
    INDEX idx_username (username)
);
```

---

#### 测试建议

**测试类型**: 集成测试 + 数据库测试
**测试数据**: 
- 空数据库（初次安装）
- 已有数据库（升级场景）

**测试场景**:
1. 空数据库执行初始化 → 表创建成功
2. 验证表结构和字段 → 所有字段正确
3. 插入初始数据 → admin账号创建成功
4. 外键约束测试 → 约束生效
5. 重复执行初始化 → 不报错，不重复创建

**自动化建议**: 高优先级，使用SpringBoot测试框架编写集成测试，验证表结构和初始数据

---

## 🔐 功能分组2：管理端（ADMIN）

### US005: 创建用户账号

#### 用户故事
> 作为 管理员，
> 我希望 能够创建新的用户账号，
> 以便 让新用户使用系统。

---

#### 验收标准

##### AC1: 正常创建用户流程

**场景描述**: 管理员填写完整的用户信息，成功创建新用户账号

**Given** 前置条件
- 管理员已登录系统（角色为ADMIN）
- 管理员在用户管理页面，点击"创建用户"按钮
- 显示用户创建表单（用户名、密码、角色下拉框）
- 用户名"newuser"不存在

**When** 管理员操作
- 在用户名输入框输入"newuser"
- 在密码输入框输入"password123"
- 在角色下拉框选择"DESIGNER"
- 点击"创建"按钮

**Then** 预期结果
- 系统验证用户名唯一性（newuser不存在）
- 系统使用BCrypt加密密码
- 插入用户记录到users表：
  - username: newuser
  - password: $2a$10$... （加密后）
  - role: DESIGNER
  - enabled: TRUE
  - created_at: 当前时间
- 创建成功后跳转到用户列表页面
- 显示成功提示："用户创建成功"
- 用户列表中显示新创建的用户"newuser"

---

##### AC2: 用户名重复校验

**场景描述**: 管理员尝试创建已存在的用户名时，系统拒绝并提示错误

**Given** 前置条件
- 管理员在用户创建表单页面
- 用户名"admin"已存在

**When** 管理员操作
- 在用户名输入框输入"admin"（已存在）
- 在密码输入框输入"password123"
- 在角色下拉框选择"VIEWER"
- 点击"创建"按钮

**Then** 预期结果
- 系统校验用户名重复
- 拒绝创建用户
- 停留在创建表单页面
- 显示错误提示："用户名已存在，请更换"（红色文字）
- 输入框保留已输入内容（除密码外）
- 用户名输入框显示红色边框

---

##### AC3: 必填字段校验

**场景描述**: 管理员未填写必填字段时，系统前端校验失败

**Given** 前置条件
- 管理员在用户创建表单页面

**When** 管理员操作（场景A：用户名为空）
- 用户名输入框为空
- 密码输入框输入"password123"
- 角色选择"VIEWER"
- 点击"创建"按钮

**Then** 预期结果
- 前端校验失败
- 停留在创建表单页面
- 用户名输入框显示红色边框
- 显示错误提示："用户名不能为空"
- 不发送创建请求到后端

**When** 管理员操作（场景B：密码为空）
- 用户名输入"newuser"
- 密码输入框为空
- 角色选择"VIEWER"
- 点击"创建"按钮

**Then** 预期结果
- 前端校验失败
- 密码输入框显示红色边框
- 显示错误提示："密码不能为空"
- 不发送请求到后端

---

##### AC4: 密码长度校验

**场景描述**: 密码长度不满足要求时，系统拒绝创建

**Given** 前置条件
- 管理员在用户创建表单页面
- 密码最低要求6位

**When** 管理员操作
- 用户名输入"newuser"
- 密码输入框输入"12345"（只有5位）
- 角色选择"DESIGNER"
- 点击"创建"按钮

**Then** 预期结果
- 前端校验失败（或后端校验失败）
- 停留在创建表单页面
- 密码输入框显示红色边框
- 显示错误提示："密码至少6位"
- 不创建用户

---

#### 边界条件

| 边界场景 | 输入条件 | 预期行为 |
|---------|---------|---------|
| 用户名长度上限 | 输入超过50个字符的用户名 | 前端限制输入，最多50字符 |
| 用户名包含空格 | 输入"new user"（包含空格） | 允许创建，但建议前端提示"用户名不建议包含空格" |
| 用户名特殊字符 | 输入"user@123" | 允许创建（不限制特殊字符） |
| 密码长度上限 | 输入超过100个字符的密码 | 前端限制输入，最多100字符 |
| 密码包含特殊字符 | 输入"P@ssw0rd!" | 允许创建（支持特殊字符） |
| 非ADMIN角色创建用户 | DESIGNER角色尝试创建用户 | 权限拦截器拒绝访问，返回403错误 |

---

#### 性能要求

| 性能指标 | 要求 | 测试方法 |
|---------|------|---------|
| 创建用户响应时间 | <1秒 | 单次创建用户操作，测量从点击"创建"到跳转用户列表的时间 |
| 密码加密时间 | <200ms | 测量BCrypt.hashpw()方法耗时 |
| 用户名唯一性校验 | <50ms | 测量查询数据库判断用户名是否存在的耗时 |

---

#### 界面要求

**必要元素**:
- 页面标题："创建用户"
- 用户名输入框（placeholder: "请输入用户名，最多50字符"）
- 密码输入框（placeholder: "请输入密码，至少6位"，type=password）
- 密码显示/隐藏切换图标（眼睛图标）
- 角色下拉框（选项：ADMIN、DESIGNER、VIEWER）
- "创建"按钮（主按钮样式，蓝色）
- "取消"按钮（次按钮样式，灰色，点击返回用户列表）

**交互行为**:
- 点击"创建"后，按钮变为禁用状态，显示"创建中..."
- 创建成功后显示Toast提示"用户创建成功"（2秒后消失）
- 创建失败时显示错误提示（红色文字，显示在表单上方）
- 输入框失焦时进行格式校验（如用户名长度、密码长度）

**响应式要求**:
- 表单宽度固定600px，居中显示
- 表单字段垂直布局，每个字段占一行
- 按钮水平并排显示在表单底部

---

#### 测试建议

**测试类型**: 功能测试 + 集成测试
**测试数据**: 
- 正常用户：newuser1/password123/DESIGNER
- 重复用户名：admin（已存在）
- 无效数据：空用户名、空密码、短密码（<6位）

**自动化建议**: 中优先级，建议编写集成测试覆盖创建用户API和前端E2E测试

---

### US006: 编辑用户信息

#### 用户故事
> 作为 管理员，
> 我希望 能够编辑用户的基本信息（角色、密码），
> 以便 修正错误或更新用户权限。

---

#### 验收标准

##### AC1: 正常编辑用户流程（修改角色）

**场景描述**: 管理员修改用户角色，保存成功

**Given** 前置条件
- 管理员已登录系统
- 用户列表中存在用户"designer1"（角色：DESIGNER）
- 管理员点击"designer1"的"编辑"按钮
- 显示用户编辑表单，预填充当前信息

**When** 管理员操作
- 用户名输入框显示"designer1"（不可编辑，灰色背景）
- 密码输入框为空（不显示原密码）
- 角色下拉框当前选择"DESIGNER"
- 修改角色为"VIEWER"
- 密码输入框保持为空（不修改密码）
- 点击"保存"按钮

**Then** 预期结果
- 系统更新users表：
  - WHERE username='designer1'
  - SET role='VIEWER', updated_at=当前时间
  - 密码字段不更新（因为输入框为空）
- 保存成功后跳转到用户列表
- 显示成功提示："用户信息更新成功"
- 用户列表中"designer1"的角色显示为"VIEWER"

---

##### AC2: 正常编辑用户流程（修改密码）

**场景描述**: 管理员修改用户密码，保存成功

**Given** 前置条件
- 管理员在用户编辑表单页面（编辑用户"viewer1"）
- 用户"viewer1"当前密码为"oldpassword"（已加密存储）

**When** 管理员操作
- 用户名显示"viewer1"（不可编辑）
- 角色保持"VIEWER"（不修改）
- 在密码输入框输入"newpassword123"（新密码）
- 点击"保存"按钮

**Then** 预期结果
- 系统使用BCrypt重新加密新密码
- 更新users表：
  - WHERE username='viewer1'
  - SET password=$2a$10$...（新密码加密后）, updated_at=当前时间
- 保存成功后跳转到用户列表
- 显示成功提示："用户信息更新成功"
- 用户"viewer1"使用新密码"newpassword123"可以登录

---

##### AC3: 密码留空不修改

**场景描述**: 管理员编辑用户但密码输入框为空时，不修改密码

**Given** 前置条件
- 管理员在用户编辑表单页面
- 编辑用户"designer1"

**When** 管理员操作
- 修改角色从"DESIGNER"到"ADMIN"
- 密码输入框保持为空（不输入任何内容）
- 点击"保存"按钮

**Then** 预期结果
- 系统仅更新角色字段：
  - SET role='ADMIN', updated_at=当前时间
  - 不更新password字段
- 保存成功
- 用户"designer1"的原密码仍然有效（未改变）

---

##### AC4: ADMIN不能修改自己的角色

**场景描述**: 管理员编辑自己的账号时，不能修改角色为非ADMIN

**Given** 前置条件
- 当前登录用户为"admin"（角色：ADMIN）
- 管理员点击编辑自己的账号

**When** 管理员操作
- 显示编辑表单，用户名为"admin"
- 尝试修改角色从"ADMIN"到"DESIGNER"
- 点击"保存"按钮

**Then** 预期结果
- 系统检测到当前用户编辑自己的账号
- 拒绝修改角色
- 显示错误提示："不能修改自己的角色"
- 停留在编辑表单页面
- 角色字段恢复为"ADMIN"

---

#### 边界条件

| 边界场景 | 输入条件 | 预期行为 |
|---------|---------|---------|
| 新密码长度不足 | 输入"123"（少于6位） | 前端校验失败，提示"密码至少6位" |
| 同时修改角色和密码 | 修改角色+输入新密码 | 两个字段都更新 |
| 不做任何修改保存 | 不修改任何字段，直接点击"保存" | 更新updated_at字段，显示"保存成功" |
| 编辑不存在的用户 | URL参数指定不存在的用户ID | 返回404错误，提示"用户不存在" |
| 非ADMIN角色编辑用户 | DESIGNER尝试编辑用户 | 权限拦截器拒绝，返回403错误 |

---

#### 性能要求

| 性能指标 | 要求 | 测试方法 |
|---------|------|---------|
| 更新用户响应时间 | <1秒 | 测量从点击"保存"到跳转用户列表的时间 |
| 密码加密时间 | <200ms | 测量BCrypt.hashpw()耗时 |

---

#### 界面要求

**必要元素**:
- 页面标题："编辑用户"
- 用户名输入框（不可编辑，灰色背景，显示当前用户名）
- 密码输入框（placeholder: "留空表示不修改密码"，type=password）
- 角色下拉框（预选当前角色）
- "保存"按钮（主按钮）
- "取消"按钮（次按钮）

**交互行为**:
- 表单加载时自动填充当前用户信息
- 用户名输入框不可编辑（cursor: not-allowed）
- 密码输入框为空，不显示原密码（安全考虑）
- 点击"保存"后按钮禁用，显示"保存中..."
- 保存成功显示Toast提示"用户信息更新成功"

---

#### 测试建议

**测试类型**: 功能测试 + 集成测试
**测试数据**: 
- 修改角色：designer1, DESIGNER → VIEWER
- 修改密码：viewer1, 输入新密码"newpass123"
- 同时修改：designer1, 角色改为ADMIN + 密码改为"newadmin123"
- 边界情况：admin编辑自己（不能改角色）

**自动化建议**: 中优先级，建议编写集成测试覆盖编辑用户API

---

### US007: 禁用/启用用户

#### 用户故事
> 作为 管理员，
> 我希望 能够禁用或启用用户账号，
> 以便 控制用户的访问权限。

---

#### 验收标准

##### AC1: 禁用启用状态的用户

**场景描述**: 管理员禁用一个启用状态的用户，用户无法登录

**Given** 前置条件
- 管理员已登录系统
- 用户列表中存在用户"viewer1"（enabled=TRUE，状态：启用）
- 用户列表中"viewer1"旁边显示"禁用"按钮

**When** 管理员操作
- 点击"viewer1"的"禁用"按钮

**Then** 预期结果
- 系统更新users表：
  - WHERE username='viewer1'
  - SET enabled=FALSE, updated_at=当前时间
- 用户列表自动刷新（或前端更新状态）
- "viewer1"的状态显示为"禁用"（灰色标签）
- "禁用"按钮变为"启用"按钮
- 显示成功提示："用户已禁用"
- 用户"viewer1"尝试登录时，系统拒绝并提示"该账号已被禁用"

---

##### AC2: 启用禁用状态的用户

**场景描述**: 管理员启用一个禁用状态的用户，用户可以登录

**Given** 前置条件
- 管理员已登录系统
- 用户列表中存在用户"designer1"（enabled=FALSE，状态：禁用）
- 用户列表中"designer1"旁边显示"启用"按钮

**When** 管理员操作
- 点击"designer1"的"启用"按钮

**Then** 预期结果
- 系统更新users表：
  - WHERE username='designer1'
  - SET enabled=TRUE, updated_at=当前时间
- 用户列表自动刷新
- "designer1"的状态显示为"启用"（绿色标签）
- "启用"按钮变为"禁用"按钮
- 显示成功提示："用户已启用"
- 用户"designer1"可以正常登录系统

---

##### AC3: ADMIN不能禁用自己

**场景描述**: 管理员尝试禁用自己的账号时，系统拒绝操作

**Given** 前置条件
- 当前登录用户为"admin"（角色：ADMIN）
- 用户列表中显示"admin"账号

**When** 管理员操作
- 点击"admin"（自己）的"禁用"按钮

**Then** 预期结果
- 系统检测到当前用户尝试禁用自己
- 拒绝操作
- 显示错误提示："不能禁用自己的账号"
- "admin"账号状态保持"启用"
- enabled字段不更新

---

##### AC4: 禁用用户后已登录Session处理（可选功能）

**场景描述**: 管理员禁用用户时，清除该用户的活跃Session

**Given** 前置条件
- 用户"viewer1"已登录系统（Session有效）
- 管理员在另一个浏览器登录

**When** 管理员操作
- 管理员禁用用户"viewer1"

**Then** 预期结果（可选实现）
- 系统更新enabled=FALSE
- 系统查找并清除"viewer1"的所有活跃Session
- 用户"viewer1"在当前浏览器中下次操作时：
  - 检测到Session无效或用户被禁用
  - 自动跳转到登录页
  - 显示提示："您的账号已被禁用"

---

#### 边界条件

| 边界场景 | 输入条件 | 预期行为 |
|---------|---------|---------|
| 重复点击"禁用" | 快速连续点击"禁用"按钮2次 | 第一次生效，第二次点击时按钮已变为"启用"，无影响 |
| 禁用不存在的用户 | 传递不存在的用户ID | 返回404错误，提示"用户不存在" |
| 非ADMIN角色禁用用户 | DESIGNER尝试禁用用户 | 权限拦截器拒绝，返回403错误 |
| 批量禁用用户（扩展功能） | 勾选多个用户，点击"批量禁用" | 所有勾选用户enabled设为FALSE |

---

#### 性能要求

| 性能指标 | 要求 | 测试方法 |
|---------|------|---------|
| 状态切换响应时间 | <500ms | 测量从点击"禁用"到状态更新的时间 |
| 批量禁用响应时间 | <2秒（禁用10个用户） | 测量批量操作耗时 |

---

#### 界面要求

**必要元素**:
- 用户列表表格，包含列：用户名、角色、状态、操作
- 状态列显示标签：
  - "启用"（绿色标签）
  - "禁用"（灰色标签）
- 操作列显示按钮：
  - "禁用"按钮（红色文字或按钮）
  - "启用"按钮（绿色文字或按钮）

**交互行为**:
- 点击"禁用"/"启用"按钮无需确认对话框（直接执行）
- 状态切换后，按钮文字和颜色立即变化
- 显示Toast提示："用户已禁用/已启用"
- 列表无需刷新整页，仅更新该行状态（前端响应式更新）

---

#### 测试建议

**测试类型**: 功能测试 + 集成测试
**测试数据**: 
- 启用用户：viewer1（enabled=TRUE）
- 禁用用户：designer1（enabled=FALSE）
- 当前登录用户：admin

**测试场景**:
1. 禁用启用状态用户 → 状态变为禁用，用户无法登录
2. 启用禁用状态用户 → 状态变为启用，用户可以登录
3. ADMIN禁用自己 → 拒绝操作，显示错误
4. 禁用用户后登录测试 → 登录失败，提示"账号已禁用"

**自动化建议**: 中优先级，建议编写集成测试覆盖状态切换API

---

### US008: 为用户分配角色

#### 用户故事
> 作为 管理员，
> 我希望 能够为用户分配角色（ADMIN/DESIGNER/VIEWER），
> 以便 控制用户的功能权限。

---

#### 验收标准

##### AC1: 正常分配角色流程

**场景描述**: 管理员为用户分配新角色，权限立即生效

**Given** 前置条件
- 管理员已登录系统
- 用户列表中存在用户"user1"（当前角色：VIEWER）
- 用户列表中显示角色下拉框或"编辑角色"按钮

**When** 管理员操作（方式1：下拉框）
- 在用户"user1"所在行，点击角色下拉框
- 下拉框显示三个选项：ADMIN、DESIGNER、VIEWER
- 选择"DESIGNER"
- 下拉框自动保存（或点击"保存"按钮）

**Then** 预期结果
- 系统更新users表：
  - WHERE username='user1'
  - SET role='DESIGNER', updated_at=当前时间
- 用户列表中"user1"的角色列显示"DESIGNER"
- 显示成功提示："角色分配成功"
- 用户"user1"下次登录时，Session中的角色为DESIGNER
- 用户"user1"可以访问DESIGNER角色的功能（如创建报表）

---

##### AC2: 角色变更立即生效（下次请求）

**场景描述**: 管理员修改用户角色后，用户下次操作时新角色生效

**Given** 前置条件
- 用户"designer1"（角色：DESIGNER）已登录系统
- 管理员在另一浏览器登录，修改"designer1"角色为VIEWER

**When** 系统操作
- 管理员将"designer1"角色从DESIGNER改为VIEWER
- 保存成功

**Then** 预期结果（下次请求生效）
- 用户"designer1"在当前Session中继续操作（角色仍为DESIGNER）
- 用户"designer1"执行下一次页面跳转或刷新时：
  - 权限拦截器检测到数据库中角色已变为VIEWER
  - 更新Session中的角色信息为VIEWER
  - 或提示用户："您的权限已变更，请重新登录"
  - 限制访问DESIGNER专属功能（如创建报表）

---

##### AC3: 角色选项验证

**场景描述**: 角色下拉框仅显示三个固定角色

**Given** 前置条件
- 管理员在用户管理页面
- 点击用户"user1"的角色下拉框

**When** 管理员操作
- 展开角色下拉框

**Then** 预期结果
- 下拉框显示三个选项（且仅三个）：
  - ADMIN（管理员）
  - DESIGNER（设计者）
  - VIEWER（普通用户）
- 当前角色高亮显示（如"user1"当前角色为VIEWER，则VIEWER选项高亮）
- 选择其他角色后，下拉框关闭并保存

---

##### AC4: ADMIN不能修改自己的角色

**场景描述**: 管理员尝试修改自己的角色时，系统拒绝操作

**Given** 前置条件
- 当前登录用户为"admin"（角色：ADMIN）
- 管理员在用户列表中找到自己的账号

**When** 管理员操作
- 点击"admin"（自己）的角色下拉框
- 尝试选择"DESIGNER"或"VIEWER"

**Then** 预期结果
- 系统检测到当前用户修改自己的角色
- 拒绝操作
- 显示错误提示："不能修改自己的角色"
- 角色下拉框恢复为"ADMIN"
- 不更新数据库

**或者（更优方案）**:
- 当前登录用户的角色下拉框禁用（灰色，不可点击）
- 鼠标悬停时显示tooltip："不能修改自己的角色"

---

#### 边界条件

| 边界场景 | 输入条件 | 预期行为 |
|---------|---------|---------|
| 分配相同角色 | user1当前角色VIEWER，再次选择VIEWER | 允许操作，更新updated_at字段，显示"角色分配成功" |
| 分配不存在的角色 | 手动构造请求，role="UNKNOWN" | 后端校验失败，返回400错误，提示"无效的角色" |
| 非ADMIN角色分配角色 | DESIGNER尝试修改用户角色 | 权限拦截器拒绝，返回403错误 |
| 批量分配角色（扩展功能） | 勾选多个用户，批量设置为VIEWER | 所有勾选用户role更新为VIEWER |

---

#### 性能要求

| 性能指标 | 要求 | 测试方法 |
|---------|------|---------|
| 角色分配响应时间 | <500ms | 测量从选择角色到显示成功提示的时间 |
| 批量分配响应时间 | <2秒（分配10个用户） | 测量批量操作耗时 |

---

#### 界面要求

**必要元素**:
- 用户列表表格，包含"角色"列
- 角色列显示下拉框或文本+编辑按钮
- 下拉框选项：ADMIN、DESIGNER、VIEWER
- 当前角色高亮显示

**交互行为**:
- 点击角色下拉框展开选项
- 选择角色后自动保存（无需额外点击"保存"按钮）
- 保存成功显示Toast提示："角色分配成功"
- 当前登录用户的角色下拉框禁用（不可修改自己）

**角色显示样式**（可选）:
- ADMIN：红色标签
- DESIGNER：蓝色标签
- VIEWER：绿色标签

---

#### 测试建议

**测试类型**: 功能测试 + 集成测试
**测试数据**: 
- 用户user1：VIEWER → DESIGNER
- 用户user2：DESIGNER → ADMIN
- 用户admin：ADMIN → VIEWER（拒绝）

**测试场景**:
1. 正常分配角色 → 角色更新成功
2. 分配相同角色 → 允许操作，updated_at更新
3. ADMIN修改自己角色 → 拒绝操作
4. 角色变更后权限测试 → VIEWER无法创建报表，DESIGNER可以创建

**自动化建议**: 中优先级，建议编写集成测试覆盖角色分配API和权限验证

---

