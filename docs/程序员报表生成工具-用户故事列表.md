# 程序员报表生成工具 - 用户故事列表

> **文档类型**: 用户故事清单（User Stories Backlog）
> **生成日期**: 2025-12-26
> **Epic来源**: 程序员报表生成工具 - MVP版本
> **Story编写规范**: INVEST原则

---

## 用户故事总览

| 故事ID | 故事标题 | 用户角色 | 功能分组 | 粒度 | 优先级 |
|--------|---------|---------|---------|------|--------|
| US001 | 用户登录功能 | 系统用户 | 基础设施层 | S | Must |
| US002 | 用户登出功能 | 系统用户 | 基础设施层 | S | Must |
| US003 | Session管理与认证拦截器 | 系统开发者 | 基础设施层 | M | Must |
| US004 | 数据库表结构初始化 | 系统开发者 | 基础设施层 | M | Must |
| US005 | 创建用户账号 | 管理员 | 管理端 | S | Must |
| US006 | 编辑用户信息 | 管理员 | 管理端 | S | Must |
| US007 | 禁用/启用用户 | 管理员 | 管理端 | S | Must |
| US008 | 为用户分配角色 | 管理员 | 管理端 | S | Must |
| US009 | 用户搜索功能 | 管理员 | 管理端 | S | Should |
| US010 | SQL编辑器实现 | 设计者 | 设计端-核心 | M | Must |
| US011 | 报表基本信息配置 | 设计者 | 设计端-核心 | S | Must |
| US012 | 参数配置功能 | 设计者 | 设计端-核心 | M | Must |
| US013 | 列配置功能 | 设计者 | 设计端-核心 | M | Must |
| US014 | 报表创建功能 | 设计者 | 设计端-核心 | S | Must |
| US015 | 报表编辑功能 | 设计者 | 设计端-核心 | S | Must |
| US016 | 报表删除功能 | 设计者 | 设计端-核心 | S | Must |
| US017 | 报表预览（测试执行） | 设计者 | 设计端-预览与授权 | M | Must |
| US018 | 为报表分配角色权限 | 设计者 | 设计端-预览与授权 | M | Must |
| US019 | 查看已授权角色列表 | 设计者 | 设计端-预览与授权 | S | Must |
| US020 | 取消角色权限 | 设计者 | 设计端-预览与授权 | S | Must |
| US021 | 查看授权报表列表 | 普通用户 | 用户端-查询 | M | Must |
| US022 | 查看报表详情 | 普通用户 | 用户端-查询 | S | Must |
| US023 | 参数输入表单 | 普通用户 | 用户端-查询 | M | Must |
| US024 | 执行报表查询 | 普通用户 | 用户端-查询 | M | Must |
| US025 | 数据表格展示 | 普通用户 | 用户端-展示与导出 | M | Must |
| US026 | 分页功能 | 普通用户 | 用户端-展示与导出 | S | Must |
| US027 | 列排序功能 | 普通用户 | 用户端-展示与导出 | S | Should |
| US028 | Excel导出功能 | 普通用户 | 用户端-展示与导出 | M | Must |
| US029 | 角色定义与权限矩阵 | 系统开发者 | 权限控制层 | M | Must |
| US030 | 权限拦截器实现 | 系统开发者 | 权限控制层 | M | Must |
| US031 | 权限缓存机制 | 系统开发者 | 权限控制层 | M | Should |
| US032 | 执行日志记录 | 系统开发者 | 权限控制层 | S | Must |
| US033 | SQL安全校验 | 系统开发者 | 技术增强 | M | Must |
| US034 | 动态列渲染优化 | 系统开发者 | 技术增强 | M | Must |
| US035 | 性能监控与优化 | 系统开发者 | 技术增强 | S | Could |

**统计信息**
- 故事总数: 35个
- 角色分布: 管理员(5个), 设计者(11个), 普通用户(8个), 系统开发者/用户(11个)
- 粒度分布: S(17个), M(18个), L(0个)
- 优先级分布: Must(30个), Should(3个), Could(2个)

---

## 📦 功能分组1：基础设施层

### US001: 用户登录功能

**用户故事**
> 作为 系统用户（管理员/设计者/普通用户），
> 我希望 能够通过用户名和密码登录系统，
> 以便 安全地访问系统功能，并根据我的角色进入对应的工作区。

**功能要点**
- 登录页面包含用户名和密码输入框
- 支持密码加密存储和验证（BCrypt）
- 登录成功后根据用户角色跳转到对应首页（管理端/设计端/用户端）
- 登录失败时显示友好的错误提示信息
- 记录登录日志（登录时间、IP地址）

**业务规则**
- 用户名和密码均为必填项
- 密码输入错误3次后锁定账号5分钟（可选）
- 登录成功后创建Session，有效期30分钟
- 首次登录需要修改初始密码（可选）

**界面要求**
- 简洁的登录页面，包含系统Logo和标题
- 支持"记住用户名"功能（可选）
- 响应式设计，支持移动端访问

**粒度评估**: S (Small) - 1天工作量，功能明确，技术成熟

---

### US002: 用户登出功能

**用户故事**
> 作为 系统用户，
> 我希望 能够安全地退出系统，
> 以便 保护我的账户安全，防止他人未经授权访问。

**功能要点**
- 点击"登出"按钮后清除用户Session
- 自动跳转到登录页面
- 清除前端存储的用户信息和Token
- 记录登出日志

**业务规则**
- 登出后所有未保存的数据将丢失（需提示用户）
- Session过期自动登出
- 长时间无操作自动登出（30分钟）

**界面要求**
- 在页面头部显示"登出"按钮
- 登出前弹出确认对话框（可选）

**粒度评估**: S (Small) - 0.5天工作量，功能简单

---

### US003: Session管理与认证拦截器

**用户故事**
> 作为 系统开发者，
> 我希望 实现Session管理和认证拦截器，
> 以便 确保所有API都需要认证才能访问，保障系统安全。

**功能要点**
- 实现SpringBoot HandlerInterceptor拦截所有API请求
- Session存储用户信息（用户ID、用户名、角色列表）
- 未登录用户访问受保护API时返回401状态码
- 每次请求刷新Session过期时间
- 白名单机制（登录、健康检查接口无需认证）

**业务规则**
- Session超时时间：30分钟
- 用户角色信息从数据库加载并缓存到Session
- 支持跨域请求的Session管理

**技术要点**
- SpringBoot HandlerInterceptor
- HttpSession管理
- Redis Session存储（可选，V2增强）

**粒度评估**: M (Medium) - 1.5天工作量，涉及安全机制设计

---

### US004: 数据库表结构初始化

**用户故事**
> 作为 系统开发者，
> 我希望 创建所有必需的数据库表结构，
> 以便 支持后续业务功能的开发和数据存储。

**功能要点**
- 创建8张核心表：user、role、user_role、report、report_param、report_column、report_role_permission、report_execution_log
- 创建必要的索引（主键、外键、查询优化索引）
- 插入初始数据：默认管理员账号、三个固定角色（ADMIN、DESIGNER、VIEWER）
- 支持数据库版本管理（Flyway或Liquibase）

**业务规则**
- 所有表必须包含created_at、updated_at字段
- 外键约束确保数据一致性
- 敏感字段（如密码）加密存储

**技术要点**
- MySQL 5.7+
- Flyway数据库版本管理
- 索引优化（user_id、report_id、role_id等）

**粒度评估**: M (Medium) - 1天工作量，涉及8张表的设计和初始化

---

## 👤 功能分组2：管理端（ADMIN）

### US005: 创建用户账号

**用户故事**
> 作为 管理员，
> 我希望 能够创建新的用户账号，
> 以便 为团队成员或外部用户提供系统访问权限。

**功能要点**
- 输入用户名、真实姓名、邮箱、初始密码
- 用户名唯一性校验
- 邮箱格式校验
- 密码复杂度校验（至少8位，包含字母和数字）
- 创建成功后自动发送邮件通知（可选）

**业务规则**
- 用户名长度：4-20个字符，仅支持字母、数字、下划线
- 邮箱必须唯一
- 初始密码由系统生成或管理员指定
- 新用户默认状态为"启用"

**界面要求**
- 用户创建表单，包含必填字段标识
- 实时校验用户名是否已存在
- 密码强度提示

**粒度评估**: S (Small) - 1天工作量，标准CRUD功能

---

### US006: 编辑用户信息

**用户故事**
> 作为 管理员，
> 我希望 能够编辑用户的基本信息，
> 以便 更新用户资料或修正错误信息。

**功能要点**
- 可编辑字段：真实姓名、邮箱、密码（重置密码）
- 不可编辑字段：用户名、创建时间
- 编辑前加载用户当前信息
- 保存后记录修改日志

**业务规则**
- 邮箱修改需要重新验证唯一性
- 密码重置需要管理员确认
- 不能编辑自己的账号角色（防止权限提升）

**界面要求**
- 用户编辑表单，预填充当前信息
- "重置密码"按钮单独处理

**粒度评估**: S (Small) - 0.5天工作量，标准编辑功能

---

### US007: 禁用/启用用户

**用户故事**
> 作为 管理员，
> 我希望 能够禁用或启用用户账号，
> 以便 管理用户的访问权限，而不删除用户历史数据。

**功能要点**
- 用户列表中显示用户状态（启用/禁用）
- 点击"禁用"按钮后，用户无法登录
- 点击"启用"按钮后，用户恢复访问权限
- 记录状态变更日志

**业务规则**
- 禁用用户后，其Session立即失效
- 禁用用户不影响其创建的报表
- 不能禁用当前登录的管理员账号
- 系统默认管理员账号不能禁用

**界面要求**
- 状态显示为徽章样式（绿色=启用，灰色=禁用）
- 禁用/启用操作需要确认对话框

**粒度评估**: S (Small) - 0.5天工作量，简单的状态切换

---

### US008: 为用户分配角色

**用户故事**
> 作为 管理员，
> 我希望 能够为用户分配角色（管理员/设计者/普通用户），
> 以便 控制用户的系统访问权限和功能范围。

**功能要点**
- 从角色列表中选择一个或多个角色分配给用户
- 显示用户当前已分配的角色
- 支持角色变更（添加/移除角色）
- 记录角色分配日志

**业务规则**
- 用户至少需要一个角色
- 支持一个用户拥有多个角色（如同时是DESIGNER和VIEWER）
- 角色变更后，用户需要重新登录才能生效
- 不能移除自己的管理员角色

**界面要求**
- 角色分配采用复选框或下拉多选
- 显示角色说明和权限范围
- 角色变更后即时保存

**粒度评估**: S (Small) - 1天工作量，涉及用户-角色关联表操作

---

### US009: 用户搜索功能

**用户故事**
> 作为 管理员，
> 我希望 能够按用户名或真实姓名搜索用户，
> 以便 快速找到需要管理的用户账号。

**功能要点**
- 搜索框支持模糊搜索（用户名、真实姓名、邮箱）
- 实时搜索（输入时动态过滤）
- 显示搜索结果数量
- 支持清空搜索条件

**业务规则**
- 搜索不区分大小写
- 搜索结果按创建时间倒序排列
- 空搜索条件时显示所有用户

**界面要求**
- 搜索框位于用户列表顶部
- 搜索结果高亮显示匹配内容

**粒度评估**: S (Small) - 0.5天工作量，标准搜索功能

---

## 👤 功能分组3：设计端（DESIGNER）- 核心功能

### US010: SQL编辑器实现

**用户故事**
> 作为 设计者，
> 我希望 有一个基于CodeMirror的SQL编辑器，支持基础语法高亮和多行编辑，
> 以便 方便地编写和调试SQL查询语句，提升开发效率。

**功能要点**
- 集成CodeMirror 5.65.x（使用vue-codemirror封装）
- SQL语法高亮（text/x-mysql模式）
- 支持多行编辑
- 代码自动缩进
- 支持快捷键（Ctrl+S保存、Ctrl+Enter执行）
- 括号自动匹配和高亮
- 高亮当前行

**业务规则**
- 仅支持SELECT语句（其他语句不允许保存）
- SQL长度限制：不超过10000个字符
- 自动保存草稿（避免意外关闭丢失）

**界面要求**
- 全屏编辑模式（可选）
- 行号显示
- Material深色主题

**技术约束**: 使用CodeMirror 5.65.x + vue-codemirror 4.0.6
**MVP范围**: 语法高亮、多行编辑、Ctrl+S保存、Ctrl+Enter执行，不包含自动补全
**粒度评估**: M (Medium) - 2天工作量（预留0.5天处理集成问题）

---

### US011: 报表基本信息配置

**用户故事**
> 作为 设计者，
> 我希望 能够配置报表的基本信息（名称、描述），
> 以便 清晰地标识和说明报表的用途。

**功能要点**
- 输入报表名称（必填）
- 输入报表描述（可选）
- 显示创建人和创建时间（自动填充）
- 报表名称唯一性校验

**业务规则**
- 报表名称长度：2-50个字符
- 报表描述长度：不超过500个字符
- 报表名称不能与已有报表重复

**界面要求**
- 表单布局，字段清晰
- 必填字段标识红色星号

**粒度评估**: S (Small) - 0.5天工作量，简单表单

---

### US012: 参数配置功能

**用户故事**
> 作为 设计者，
> 我希望 能够为报表配置查询参数（参数名、类型、默认值、是否必填），
> 以便 用户在查询时能输入动态条件。

**功能要点**
- 添加参数：参数名、参数类型（字符串/数字/日期）、默认值、是否必填
- 编辑参数配置
- 删除参数
- 参数排序（上移/下移）
- 参数占位符格式验证：`#{paramName}`

**业务规则**
- 参数名唯一性校验（同一报表内）
- 参数名格式：仅支持字母、数字、下划线，不能以数字开头
- 参数类型：STRING、NUMBER、DATE、DATETIME
- 必填参数必须有默认值（可选规则）

**界面要求**
- 参数列表，支持拖拽排序
- 参数类型下拉选择
- "添加参数"按钮

**粒度评估**: M (Medium) - 1.5天工作量，涉及动态表单和列表管理

---

### US013: 列配置功能

**用户故事**
> 作为 设计者，
> 我希望 能够配置查询结果的列属性（显示名称、列宽、格式化），支持从SQL结果集自动提取字段名，
> 以便 用户看到友好的数据展示，减少手动配置工作量。

**前置依赖**: US010（SQL编辑器）、US017（报表预览，用于测试执行SQL）
**技术难点**: ResultSetMetaData列信息提取、类型映射（JDBC → 前端格式化类型）

**功能要点**
- 自动从SQL结果集提取字段名
- 配置每列的显示名称
- 配置列宽（像素）
- 配置数据格式化（日期格式、数字精度、货币符号）
- 列排序（上移/下移）
- 隐藏/显示列

**业务规则**
- 字段名来自SQL查询结果（自动提取）
- 显示名称默认等于字段名
- 列宽默认100像素
- 格式化类型：默认、日期（YYYY-MM-DD）、数字（保留2位小数）、货币（¥）

**界面要求**
- 列配置表格，每行一列
- 支持批量操作（全部显示/隐藏）

**粒度评估**: M (Medium) - 2天工作量（包含0.5天技术预研，动态列提取和配置）

---

### US014: 报表创建功能

**用户故事**
> 作为 设计者，
> 我希望 能够创建新的报表，包括填写基本信息、编写SQL、配置参数和列，并通过测试执行验证SQL正确性，
> 以便 为用户提供数据查询功能。

**前置依赖**: US010（SQL编辑器）、US011（基本信息配置）、US012（参数配置）、US013（列配置）

**功能要点**
- 填写报表基本信息（名称、描述）
- 编写SQL查询语句
- 配置查询参数
- 配置列属性
- 保存报表（生成报表ID）

**业务规则**
- 创建报表时自动关联创建人
- 报表创建后默认状态为"草稿"
- 保存前必须通过测试执行（至少执行一次无错误）
- 保存成功后自动跳转到报表列表

**验收标准**:
- [ ] 报表名称不能与已有报表重复（保存时校验）
- [ ] SQL不能为空（前端校验）
- [ ] 保存前必须通过测试执行（至少执行一次无错误）
- [ ] SQL执行失败时显示具体错误信息（如语法错误、表不存在）
- [ ] 保存成功后跳转到报表列表，显示新建的报表

**界面要求**
- 多步骤表单（Step 1: 基本信息 → Step 2: SQL编辑 → Step 3: 参数配置 → Step 4: 列配置）
- 支持保存草稿

**粒度评估**: S (Small) - 1天工作量（整合功能为主，新增保存逻辑和校验）

---

### US015: 报表编辑功能

**用户故事**
> 作为 设计者，
> 我希望 能够编辑已有报表的配置，
> 以便 修正错误或优化报表功能。

**功能要点**
- 加载报表当前配置（基本信息、SQL、参数、列配置）
- 编辑所有可配置项
- 保存修改（更新updated_at字段）
- 记录修改日志（可选）

**业务规则**
- 只能编辑自己创建的报表（或管理员可编辑所有）
- 编辑后需要重新测试执行
- 如果报表已授权给用户，修改后需要通知用户（可选）

**界面要求**
- 与创建报表相同的表单，预填充当前配置
- 显示"最后修改时间"

**粒度评估**: S (Small) - 0.5天工作量，复用创建功能

---

### US016: 报表删除功能

**用户故事**
> 作为 设计者，
> 我希望 能够删除不再需要的报表，
> 以便 保持报表列表的整洁。

**功能要点**
- 从报表列表中选择报表并删除
- 删除前弹出确认对话框
- 删除报表同时删除关联的参数、列配置、权限记录
- 记录删除日志

**业务规则**
- 只能删除自己创建的报表（或管理员可删除所有）
- 删除后数据不可恢复（或软删除，可选）
- 删除前检查是否有用户正在使用该报表（可选）

**界面要求**
- 报表列表中显示"删除"按钮
- 确认对话框显示报表名称和警告信息

**粒度评估**: S (Small) - 0.5天工作量，标准删除功能
查看前100行结果并验证列配置的正确性，
> 以便 确保报表能够正常工作，避免保存错误配置。

**前置依赖**: 
- US010（SQL编辑器）
- US012（参数配置，生成参数输入表单）
- US013（列配置，提取字段并配置显示）
- US033（SQL安全校验，并行开发）

**技术要点**:
- 使用PreparedStatement参数化执行
- 查询超时控制：5秒
- 仅返回前100行数据（避免大数据量影响性能）
- 使用只读数据库账号

**功能要点**
- 点击"测试执行"按钮
- 弹出参数输入对话框（如果有参数）
- 执行SQL查询，返回前100行结果
- 显示查询结果表格（按列配置展示）
- 显示执行时间和结果行数
- 支持多次测试执行（修改参数后重新执行）

**业务规则**
- 测试执行时不保存报表
- 查询超时时间：5秒
- 最多返回100行数据（避免大数据量影响性能）
- 使用只读数据库账号执行查询

**界面要求**
- 参数输入表单（基于参数配置动态生成）
- 数据表格展示（支持横向滚动）
- 显示执行信息（执行时间、行数）

**粒度评估**: M (Medium) - 2.5天工作量（SQL执行引擎2天 + 前端动态渲染0.5天）
- 最多返回100行数据（避免大数据量影响性能）
- 使用只读数据库账号执行查询

**界面要求**
- 参数输入表单（基于参数配置动态生成）
- 数据表格展示（支持横向滚动）
- 显示执行信息（执行时间、行数）

**粒度评估**: M (Medium) - 2天工作量，涉及动态SQL执行和结果渲染

---

### US018: 为报表分配角色权限

**用户故事**
> 作为 设计者，
> 我希望 能够为报表分配角色权限（VIEWER/DESIGNER），
> 以便 控制哪些用户可以查看和使用该报表。

**功能要点**
- 显示三个固定角色：ADMIN、DESIGNER、VIEWER
- 勾选角色复选框，为报表分配权限
- ADMIN角色默认有所有权限（不可取消）
- 保存权限分配
- 显示已授权角色列表

**业务规则**
- 报表创建后默认仅创建人可访问
- ADMIN角色始终拥有所有报表的访问权限
- DESIGNER角色可访问已授权报表并进行编辑
- VIEWER角色可访问已授权报表但只能查看

**界面要求**
- 角色权限配置对话框
- 复选框选择角色
- 显示角色说明和权限范围

**粒度评估**: M (Medium) - 1.5天工作量，涉及权限表操作

---

### US019: 查看已授权角色列表

**用户故事**
> 作为 设计者，
> 我希望 能够查看报表已授权的角色列表，
> 以便 了解哪些用户可以访问该报表。

**功能要点**
- 在报表详情页显示已授权角色列表
- 显示角色名称和授权时间
- 显示授权人（管理员）

**业务规则**
- 只显示当前报表的授权角色
- ADMIN角色始终在列表中（即使未显式授权）

**界面要求**
- 授权角色列表，表格或卡片展示
- 每个角色显示徽章样式

**粒度评估**: S (Small) - 0.5天工作量，简单查询展示

---

### US020: 取消角色权限

**用户故事**
> 作为 设计者，
> 我希望 能够取消已授权角色的权限，
> 以便 撤回对特定角色的报表访问权限。

**功能要点**
- 在已授权角色列表中点击"取消授权"按钮
- 弹出确认对话框
- 删除权限记录
- 更新授权角色列表

**业务规则**
- 不能取消ADMIN角色的权限
- 取消授权后，该角色的用户立即失去访问权限
- 取消授权需要确认操作

**界面要求**
- 每个授权角色旁边显示"取消授权"按钮
- 确认对话框说明取消授权的影响

**粒度评估**: S (Small) - 0.5天工作量，标准删除功能

---

## 👤 功能分组5：用户端（VIEWER）- 查询功能

### US021: 查看授权报表列表

**用户故事**
> 作为 普通用户，
> 我希望 能够查看我有权限访问的报表列表，
> 以便 选择需要查询的报表。

**功能要点**
- 显示当前用户有权限的报表列表
- 显示报表名称、描述、创建人、创建时间
- 支持报表搜索（按名称模糊搜索）
- 点击报表进入查询页面

**业务规则**
- 仅显示已授权的报表（基于用户角色）
- ADMIN角色可查看所有报表
- 报表列表按创建时间倒序排列
- 禁用的用户无法查看报表列表

**界面要求**
- 报表列表，卡片或表格展示
- 搜索框位于列表顶部
- 显示报表数量

**粒度评估**: M (Medium) - 1.5天工作量，涉及权限过滤逻辑

---

### US022: 查看报表详情

**用户故事**
> 作为 普通用户，
> 我希望 能够查看报表的详细信息（名称、描述、参数说明），
> 以便 了解报表的用途和查询方式。

**功能要点**
- 显示报表名称和描述
- 显示报表创建人和创建时间
- 显示参数列表和参数说明（参数名、类型、是否必填、默认值）
- 显示"执行查询"按钮

**业务规则**
- 仅显示有权限的报表详情
- 访问无权限报表时返回403错误

**界面要求**
- 报表详情页，信息清晰展示
- 参数说明采用表格或列表

**粒度评估**: S (Small) - 0.5天工作量，简单展示页面

---

### US023: 参数输入表单

**用户故事**
> 作为 普通用户，
> 我希望 系统根据报表参数配置自动生成输入表单，支持不同类型的输入控件（文本框、数字框、日期选择器），
> 以便 方便地输入查询条件，无需手动构造参数。

**前置依赖**: US012（参数配置，提供参数定义数据）
**支持的参数类型**: STRING（文本框）、NUMBER（数字框）、DATE（日期选择器）、DATETIME（日期时间选择器）

**功能要点**
- 根据报表参数配置动态生成表单
- 支持不同参数类型的输入控件（文本框、数字框、日期选择器）
- 显示参数默认值
- 必填参数校验
- 参数格式校验（如日期格式、数字范围）

**业务规则**
- 必填参数不能为空
- 日期参数格式：YYYY-MM-DD
- 数字参数仅允许输入数字
- 参数输入后自动保存到浏览器本地存储（下次自动填充）

**验收标准**:
- [ ] 不同参数类型对应正确的输入控件
- [ ] 必填参数校验（不能为空）
- [ ] 数据类型校验（数字/日期格式）
- [ ] 默认值自动填充
- [ ] 参数输入后保存到本地存储（下次自动填充）

**界面要求**
- 表单布局清晰，每个参数占一行
- 必填参数标识红色星号
- 参数说明显示在输入框下方

**粒度评估**: M (Medium) - 2天工作量（动态表单生成1.5天 + 本地存储0.5天）

---

### US024: 执行报表查询

**用户故事**
> 作为 普通用户，
> 我希望 能够执行报表查询，
> 以便 获取我需要的数据。

**功能要点**
- 点击"查询"按钮执行SQL
- 参数必填校验
- 显示加载动画（查询中）
- 查询成功后显示数据表格
- 查询失败时显示错误提示
- 记录查询日志（用户、报表、参数、时间）

**业务规则**
- 查询前校验用户权限
- 查询超时时间：5秒
- 查询结果最多返回5000行
- 超过5000行时提示用户添加筛选条件

**界面要求**
- "查询"按钮明显，点击后禁用（防止重复提交）
- 加载动画提示用户查询中
- 错误提示清晰友好

**粒度评估**: M (Medium) - 2天工作量，涉及SQL执行和权限校验

---

## 👤 功能分组6：用户端（VIEWER）- 展示与导出

### US025: 数据表格展示

**用户故事**
> 作为 普通用户，
> 我希望 查询结果以表格形式清晰展示，支持动态列渲染和数据格式化（日期、数字、货币），
> 以便 方便地浏览和分析数据。

**前置依赖**: 
- US013（列配置，提供列元数据）
- US024（执行报表查询，提供数据源）
- US034（动态列渲染优化，并行开发或提前完成）

**技术方案**:
- Element UI Table组件
- v-for动态列渲染
- 数据格式化工具函数（formatDate、formatNumber、formatCurrency）

**功能要点**
- 使用Element UI Table组件展示数据
- 根据列配置显示列名（显示名称）
- 支持横向滚动（列多时）
- 支持列宽调整（可选）
- 显示总行数

**业务规则**
- 列名显示为配置的"显示名称"
- 日期字段格式化为YYYY-MM-DD
- 数字字段格式化（保留2位小数）
- 空值显示为"-"

**界面要求**
- 表格样式清晰，支持斑马纹
- 表头固定（滚动时不消失）
- 表格下方显示总行数

**粒度评估**: M (Medium) - 2天工作量（表格展示1天 + 格式化+样式优化1天）

---

### US026: 分页功能

**用户故事**
> 作为 普通用户，
> 我希望 查询结果支持分页展示，
> 以便 在数据量大时方便浏览。

**功能要点**
- 每页显示100条数据
- 显示分页控件（首页、上一页、下一页、尾页、跳转）
- 显示当前页码和总页数
- 分页在前端实现（一次性加载所有数据）

**业务规则**
- 默认显示第1页
- 每页固定100条
- 总数据量不超过5000行

**界面要求**
- 分页控件位于表格下方
- 显示"共X条数据，第Y页/共Z页"

**粒度评估**: S (Small) - 0.5天工作量，Element UI自带分页组件

---

### US027: 列排序功能

**用户故事**
> 作为 普通用户，
> 我希望 能够按列排序数据，
> 以便 快速找到需要的信息。

**功能要点**
- 点击列头进行升序/降序排序
- 支持数字排序、日期排序、字符串排序
- 排序后保持分页状态
- 排序在前端实现

**业务规则**
- 默认不排序（按查询结果顺序）
- 仅支持单列排序（点击其他列取消上一次排序）
- 空值排在最后

**界面要求**
- 列头显示排序图标（↑↓）
- 当前排序列高亮显示

**粒度评估**: S (Small) - 0.5天工作量，Element UI自带排序功能

---

### US028: Excel导出功能

**用户故事**
> 作为 普通用户，
> 我希望 能够将查询结果导出为Excel文件，
> 以便 在本地进行进一步分析或分享给他人。

**功能要点**
- 点击"导出Excel"按钮
- 生成Excel文件（.xlsx格式）
- 文件名格式：`报表名_YYYYMMDD_HHmmss.xlsx`
- 包含表头（显示名称）和数据行
- 浏览器自动下载文件

**业务规则**
- 限制导出行数：最多5000行
- 超过5000行时提示用户添加筛选条件
- 导出前校验用户权限
- 记录导出日志（用户、报表、导出时间、行数）

**技术要点**
- 后端：Apache POI生成Excel
- 前端：Axios下载文件流

**界面要求**
- "导出Excel"按钮位于表格上方
- 导出中显示进度提示
- 导出成功后自动下载

**粒度评估**: M (Medium) - 2天工作量，涉及POI Excel生成

---

## 🔐 功能分组7：权限控制层（RBAC）

### US029: 角色定义与权限矩阵

**用户故事**
> 作为 系统开发者，
> 我希望 定义三个固定角色及其权限矩阵，
> 以便 实现基于角色的权限控制。

**功能要点**
- 定义三个角色：ADMIN（管理员）、DESIGNER（设计者）、VIEWER（普通用户）
- 定义权限矩阵：角色对应的功能权限
- 角色数据预置到数据库（role表）
- 权限矩阵硬编码到代码中（Java枚举）

**业务规则**
- ADMIN拥有所有权限（管理端、设计端、用户端）
- DESIGNER拥有设计端和用户端权限
- VIEWER仅拥有用户端权限
- 权限继承：ADMIN > DESIGNER > VIEWER

**技术要点**
- Java枚举定义角色和权限
- 权限矩阵可通过配置文件扩展（V2增强）

**粒度评估**: M (Medium) - 1天工作量，涉及权限模型设计

---

### US030: 权限拦截器实现

**用户故事**
> 作为 系统开发者，
> 我希望 实现权限拦截器，
> 以便 在每次API请求时校验用户权限。

**功能要点**
- 实现SpringBoot HandlerInterceptor
- 拦截所有API请求（除白名单）
- 从Session获取用户角色
- 校验用户角色是否有权限访问该API
- 无权限时返回403状态码

**业务规则**
- 白名单：登录、登出、健康检查接口
- 权限校验规则：API路径与角色权限矩阵匹配
- ADMIN角色绕过所有权限检查

**技术要点**
- SpringBoot HandlerInterceptor
- 注解方式标记API权限（@PreAuthorize）

**粒度评估**: M (Medium) - 1.5天工作量，涉及拦截器和权限校验逻辑

---

### US031: 权限缓存机制

**用户故事**
> 作为 系统开发者，
> 我希望 实现权限缓存机制，
> 以便 减少数据库查询，提升性能。

**功能要点**
- 用户角色信息缓存到Session（首次登录时加载）
- 报表权限信息缓存（TTL=5分钟）
- 缓存更新策略：角色变更时清除缓存
- 缓存失效后自动从数据库重新加载

**业务规则**
- Session缓存有效期：30分钟
- 报表权限缓存有效期：5分钟
- 用户角色变更后需要重新登录

**技术要点**
- Caffeine本地缓存（MVP）
- Redis分布式缓存（V2增强）

**粒度评估**: M (Medium) - 1天工作量，涉及缓存设计

---

### US032: 执行日志记录

**用户故事**
> 作为 系统开发者，
> 我希望 记录所有报表执行和导出操作的日志，
> 以便 审计和问题排查。

**功能要点**
- 记录报表执行日志：用户、报表、参数、执行时间、结果行数、状态（成功/失败）
- 记录Excel导出日志：用户、报表、导出时间、导出行数
- 记录用户登录/登出日志（可选）
- 日志存储到数据库（report_execution_log表）

**业务规则**
- 每次查询和导出都必须记录日志
- 日志保留时间：90天（可配置）
- 日志查询功能（管理员可查看所有日志）

**技术要点**
- AOP切面记录日志
- 异步写入日志（避免影响性能）

**粒度评估**: S (Small) - 1天工作量，标准日志记录

---

## 🔧 功能分组8：技术增强功能

### US033: SQL安全校验

**用户故事**
> 作为 系统开发者，
> 我希望 实现SQL安全校验机制，
> 以便 防止SQL注入和恶意查询。

**功能要点**
- SQL白名单校验：仅允许SELECT语句
- SQL黑名单校验：禁止DROP、DELETE、TRUNCATE、UPDATE、INSERT、ALTER、CREATE、EXEC等关键字
- PreparedStatement参数化执行
- 查询超时控制：5秒
- 使用只读数据库账号

**业务规则**
- 保存报表前必须通过SQL校验
- 测试执行和正式查询都使用相同的校验规则
- SQL包含危险关键字时拒绝保存并提示错误

**技术要点**
- 正则表达式匹配SQL关键字
- PreparedStatement防止SQL注入
- MySQL只读账号权限控制

**粒度评估**: M (Medium) - 1.5天工作量，涉及SQL解析和校验

---

### US034: 动态列渲染优化

**用户故事**
> 作为 系统开发者，
> 我希望 实现一套统一的动态列渲染方案（后端列信息提取 + 前端动态组件），
> 以便 US013/US017/US025等Story可以复用此技术能力，避免重复开发，提升大数据量渲染性能。

**业务价值**:
- 统一列信息提取逻辑，减少重复代码
- 提升大数据量（>1000行）渲染性能（目标：1000行<3秒渲染）
- 提供可复用的Vue列渲染组件

**技术方案**:
- 后端：ResultSetMetaData提取列信息、JDBC类型 → 前端格式化类型映射
- 前端：Vue动态组件（DynamicTableColumn）、虚拟滚动（可选）

**依赖此Story的功能**: US013、US017、US025

**功能要点**
- 从ResultSet元数据提取列信息（列名、类型）
- 根据列类型自动选择格式化规则（日期、数字、字符串）
- Vue动态组件渲染（v-for + 动态列配置）
- 虚拟滚动（大数据量时，可选）

**业务规则**
- 列名优先使用配置的"显示名称"
- 未配置的列使用字段名
- 数据类型推断：DATE → 日期格式，DECIMAL → 数字格式

**技术要点**
- ResultSetMetaData提取列信息
- Vue动态组件渲染
- Element UI Table动态列

**粒度评估**: M (Medium) - 2天工作量（后端1天 + 前端1天）

---

### US035: 性能监控与优化

**用户故事**
> 作为 系统开发者，
> 我希望 实现性能监控机制，
> 以便 发现和解决性能瓶颈。

**功能要点**
- 记录API响应时间（AOP切面）
- 记录SQL执行时间
- 慢查询日志（执行时间>3秒）
- 性能监控仪表盘（可选，管理员可查看）

**业务规则**
- 慢查询阈值：3秒
- 慢查询自动告警（邮件或日志）
- 性能数据保留7天

**技术要点**
- AOP切面记录性能数据
- 日志框架（Logback）
- 性能监控工具（Prometheus + Grafana，可选）

**粒度评估**: S (Small) - 1天工作量，标准性能监控

---

## 📊 用户故事依赖关系图

```
基础设施层（US001-US004）
    ↓ 依赖
管理端（US005-US009）+ 权限控制层（US029-US030）
    ↓ 依赖
设计端核心（US010-US016）
    ↓ 依赖
设计端预览与授权（US017-US020）
    ↓ 依赖
用户端查询（US021-US024）
    ↓ 依赖
用户端展示与导出（US025-US028）
    ↓ 并行
技术增强（US033-US035）+ 权限完善（US031-US032）
```

---

## 🎯 迭代规划建议

### Sprint 1（第1周）- 基础设施 + 管理端 + 设计端核心

**目标**: 搭建框架，完成报表设计功能

**Story列表**: US001-US020（20个Story）

**预估工作量**: 12人日

**关键里程碑**:
- Day 1-2: 基础设施层（登录、Session、数据库）
- Day 3-4: 管理端（用户管理、角色分配）
- Day 5-7: 设计端核心（SQL编辑器、参数/列配置、报表CRUD）
- Day 8-10: 设计端预览与授权（测试执行、权限分配）

---

### Sprint 2（第2周）- 用户端 + 技术增强 + 联调测试

**目标**: 完成用户端查询和导出，系统联调测试

**Story列表**: US021-US035（15个Story）

**预估工作量**: 10人日

**关键里程碑**:
- Day 11-13: 用户端查询（报表列表、参数输入、执行查询）
- Day 14-15: 用户端展示与导出（表格展示、分页、Excel导出）
- Day 16-17: 技术增强（SQL安全校验、动态列渲染、性能监控）
- Day 18-19: 权限完善（权限缓存、执行日志）
- Day 20: 端到端测试与Bug修复

---

## ✅ 验收标准检查清单

### 每个用户故事需满足INVEST原则

- [ ] **I - Independent (独立性)**: Story之间尽量独立，减少依赖
- [ ] **N - Negotiable (可协商性)**: 实现细节可与开发团队协商
- [ ] **V - Valuable (有价值性)**: 每个Story对用户有明确价值
- [ ] **E - Estimable (可估算性)**: 开发团队能估算工作量
- [ ] **S - Small (小型化)**: 单个Story在1-2天内可完成
- [ ] **T - Testable (可测试性)**: 有明确的验收标准

---

**文档状态**: 已完成 ✅
**下一步**: 
1. 产品经理评审用户故事
2. 开发团队评估工作量（Story Point）
3. Sprint 1启动会，明确任务分工
