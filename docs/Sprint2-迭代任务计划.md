# Sprint 2 迭代任务计划

> **Sprint周期**: 第3周（5个工作日）  
> **Sprint目标**: 完成报表预览与权限管理，加强安全防护  
> **团队**: 开发者A（前端）+ 开发者B（后端）  
> **工作量**: 9人日

---

## 📊 Sprint 2 Story清单

| Story ID | 故事标题 | 优先级 | 工作量 | 负责人 | 状态 |
|----------|---------|--------|--------|--------|------|
| US017 | 报表测试执行（预览） | P0 | 3天 | A+B | ⚪ 待开始 |
| US018 | 报表权限配置 | P0 | 2天 | A+B | ⚪ 待开始 |
| US033 | SQL注入防护 | P0 | 2天 | B | ⚪ 待开始 |
| US034 | 列渲染优化 | P1 | 2天 | A | ⚪ 待开始 |

---

## 📋 US017: 报表测试执行（预览）

### 故事描述
**作为** 报表设计者  
**我想要** 在设计时预览报表执行结果  
**以便** 验证SQL和参数配置是否正确

### 故事验收标准
- [ ] 可以输入参数值
- [ ] 点击执行按钮查询数据
- [ ] 查询结果以表格形式展示（前100行）
- [ ] 显示执行时间统计
- [ ] 查询失败显示错误信息
- [ ] 查询超时5秒自动终止

### 详细任务拆解

#### T017-1: 参数输入表单UI（开发者A，2h）
**描述**: 创建参数输入表单
**验收标准**:
- [ ] 根据参数配置动态生成表单
- [ ] STRING类型显示文本框
- [ ] NUMBER类型显示数字框
- [ ] DATE类型显示日期选择器
- [ ] DATETIME类型显示日期时间选择器
- [ ] 必填参数标记*号
- [ ] 表单验证生效

#### T017-2: 执行按钮与加载状态（开发者A，1h）
**描述**: 实现执行按钮和加载提示
**验收标准**:
- [ ] 执行按钮显眼（主色调）
- [ ] 点击后显示loading状态
- [ ] Loading期间按钮禁用
- [ ] 执行成功按钮恢复
- [ ] 执行失败按钮恢复

#### T017-3: 结果表格展示（开发者A，3h）
**描述**: 展示查询结果
**验收标准**:
- [ ] 使用Element Plus Table组件
- [ ] 动态生成表格列
- [ ] 显示前100行数据
- [ ] 应用列配置（列宽、显示名称）
- [ ] 空结果显示友好提示
- [ ] 表格支持横向滚动

#### T017-4: 执行时间统计（开发者A，1h）
**描述**: 显示执行耗时
**验收标准**:
- [ ] 显示格式：执行时间 1.23秒
- [ ] 精确到毫秒
- [ ] 位置在表格上方
- [ ] 颜色区分（绿色<1s，橙色1-3s，红色>3s）
- [ ] 图标提示

#### T017-5: 错误提示展示（开发者A，1h）
**描述**: 显示执行错误信息
**验收标准**:
- [ ] 使用Message.error显示错误
- [ ] SQL语法错误显示详细信息
- [ ] 参数错误显示参数名
- [ ] 超时错误提示超时
- [ ] 错误信息可复制

#### T017-6: 测试执行API（开发者B，4h）
**描述**: 实现POST /api/v1/reports/preview接口
**验收标准**:
- [ ] 接收SQL、参数配置、参数值
- [ ] 校验SQL合法性（调用SqlValidator）
- [ ] 使用命名参数执行查询
- [ ] 限制返回100行
- [ ] 返回结果集和执行时间

#### T017-7: 查询超时控制（开发者B，2h）
**描述**: 实现查询超时机制
**验收标准**:
- [ ] 查询超时5秒自动终止
- [ ] 超时抛出TimeoutException
- [ ] 返回超时错误提示
- [ ] 不影响数据库连接池
- [ ] 单元测试覆盖超时场景

#### T017-8: 查询结果格式化（开发者B，2h）
**描述**: 格式化查询结果
**验收标准**:
- [ ] 日期格式化为yyyy-MM-dd
- [ ] 日期时间格式化为yyyy-MM-dd HH:mm:ss
- [ ] 数字保留2位小数
- [ ] NULL显示为空字符串
- [ ] 大对象（CLOB/BLOB）显示[CLOB]/[BLOB]

#### T017-9: 参数类型转换（开发者B，2h）
**描述**: 转换前端参数值为正确类型
**验收标准**:
- [ ] STRING保持原样
- [ ] NUMBER转换为Integer/Double
- [ ] DATE转换为java.sql.Date
- [ ] DATETIME转换为java.sql.Timestamp
- [ ] 转换失败抛出异常

#### T017-10: 测试执行E2E测试（开发者A+B，2h）
**描述**: 端到端测试
**验收标准**:
- [ ] 无参数查询测试通过
- [ ] 单参数查询测试通过
- [ ] 多参数查询测试通过
- [ ] 查询失败测试通过
- [ ] 查询超时测试通过
- [ ] 单元测试覆盖率>80%

---

## 📋 US018: 报表权限配置

### 故事描述
**作为** 报表设计者  
**我想要** 配置报表的访问权限  
**以便** 控制哪些角色可以使用报表

### 故事验收标准
- [ ] 可以选择允许访问的角色
- [ ] 支持多角色选择
- [ ] 保存权限配置到数据库
- [ ] 未授权用户无法查看报表
- [ ] 权限配置可以修改

### 详细任务拆解

#### T018-1: 权限配置UI（开发者A，2h）
**描述**: 创建权限配置界面
**验收标准**:
- [ ] 使用Checkbox Group显示角色列表
- [ ] ADMIN、DESIGNER、VIEWER三个选项
- [ ] 支持多选
- [ ] 默认选中当前用户角色
- [ ] 布局清晰

#### T018-2: 权限配置保存（开发者A，1.5h）
**描述**: 保存权限配置
**验收标准**:
- [ ] 调用POST /api/v1/reports/{id}/permissions接口
- [ ] 提交选中的角色数组
- [ ] 保存成功显示Toast
- [ ] 保存失败显示错误
- [ ] 更新成功刷新界面

#### T018-3: 权限配置保存API（开发者B，2h）
**描述**: 实现POST /api/v1/reports/{id}/permissions接口
**验收标准**:
- [ ] 接收角色数组
- [ ] 删除旧权限配置
- [ ] 批量插入新权限配置
- [ ] 使用事务保证一致性
- [ ] 更新报表updated_at

#### T018-4: 权限校验拦截器（开发者B，3h）
**描述**: 实现权限校验
**验收标准**:
- [ ] 创建ReportPermissionInterceptor
- [ ] 从Session获取用户角色
- [ ] 查询报表权限配置
- [ ] 角色不匹配返回403
- [ ] ADMIN角色绕过权限检查

#### T018-5: 报表列表权限过滤（开发者B，2h）
**描述**: 列表仅显示有权限的报表
**验收标准**:
- [ ] 修改GET /api/v1/reports接口
- [ ] 根据当前用户角色过滤
- [ ] ADMIN查看所有报表
- [ ] 其他角色仅查看授权报表
- [ ] SQL使用JOIN关联查询

#### T018-6: 权限配置测试（开发者A+B，1.5h）
**描述**: 测试权限功能
**验收标准**:
- [ ] 权限配置保存测试通过
- [ ] 权限校验测试通过
- [ ] 未授权访问测试通过
- [ ] ADMIN绕过权限测试通过
- [ ] 单元测试覆盖率>85%

---

## 📋 US033: SQL注入防护

### 故事描述
**作为** 系统  
**我想要** 防止SQL注入攻击  
**以便** 保护数据库安全

### 故事验收标准
- [ ] 拒绝非SELECT语句
- [ ] 拒绝包含DROP/DELETE/UPDATE关键字的SQL
- [ ] 拒绝注释符号（--、/**/）
- [ ] 拒绝分号分隔的多语句
- [ ] 强制使用参数化查询
- [ ] 单元测试覆盖所有注入场景

### 详细任务拆解

#### T033-1: SqlValidator关键字黑名单（开发者B，2h）
**描述**: 实现SQL关键字黑名单
**验收标准**:
- [ ] 黑名单包含DROP、DELETE、TRUNCATE、UPDATE、INSERT
- [ ] 黑名单包含ALTER、CREATE、GRANT、REVOKE、EXEC
- [ ] 黑名单包含SCRIPT、JAVASCRIPT
- [ ] 大小写不敏感
- [ ] 配置可扩展

#### T033-2: SQL语句类型校验（开发者B，1.5h）
**描述**: 仅允许SELECT语句
**验收标准**:
- [ ] trim后转大写判断
- [ ] SELECT开头允许
- [ ] 其他语句拒绝
- [ ] 日志记录拒绝原因
- [ ] 返回明确错误信息

#### T033-3: 注释符号检测（开发者B，1h）
**描述**: 拒绝SQL注释
**验收标准**:
- [ ] 检测-- 注释
- [ ] 检测/* */ 注释
- [ ] 拒绝包含注释的SQL
- [ ] 日志记录拒绝原因
- [ ] 返回明确错误信息

#### T033-4: 多语句检测（开发者B，1h）
**描述**: 拒绝分号分隔的多语句
**验收标准**:
- [ ] 检测分号;
- [ ] 拒绝包含分号的SQL
- [ ] 允许字符串内的分号
- [ ] 日志记录拒绝原因
- [ ] 返回明确错误信息

#### T033-5: 参数化查询强制（开发者B，2h）
**描述**: 确保使用命名参数
**验收标准**:
- [ ] 禁止字符串拼接
- [ ] 使用NamedParameterJdbcTemplate
- [ ] 参数值自动转义
- [ ] 代码审查规则配置
- [ ] 单元测试覆盖

#### T033-6: SQL注入测试套件（开发者B，3h）
**描述**: 完整的注入防护测试
**验收标准**:
- [ ] 测试DROP TABLE注入
- [ ] 测试UNION注入
- [ ] 测试注释绕过
- [ ] 测试参数注入
- [ ] 测试布尔盲注
- [ ] 测试时间盲注
- [ ] 测试堆叠查询
- [ ] 所有测试通过

#### T033-7: 安全审计日志（开发者B，1.5h）
**描述**: 记录SQL拒绝日志
**验收标准**:
- [ ] 记录拒绝的SQL
- [ ] 记录拒绝原因
- [ ] 记录用户信息
- [ ] 记录时间戳
- [ ] 日志级别WARN

#### T033-8: 安全文档编写（开发者B，1h）
**描述**: 编写SQL安全规范文档
**验收标准**:
- [ ] 文档说明SQL注入风险
- [ ] 文档说明防护措施
- [ ] 文档包含安全编码示例
- [ ] 文档包含测试用例
- [ ] 文档审查通过

---

## 📋 US034: 列渲染优化

### 故事描述
**作为** 用户  
**我想要** 查询结果按配置的格式显示  
**以便** 更好地理解数据

### 故事验收标准
- [ ] 日期格式化为yyyy-MM-dd
- [ ] 日期时间格式化为yyyy-MM-dd HH:mm:ss
- [ ] 数字千分位分隔
- [ ] 货币显示为¥1,234.56
- [ ] 隐藏列不显示
- [ ] 列宽应用到表格

### 详细任务拆解

#### T034-1: 日期格式化（开发者A，1.5h）
**描述**: 实现日期格式化
**验收标准**:
- [ ] 识别DATE类型列
- [ ] 格式化为yyyy-MM-dd
- [ ] 空值显示--
- [ ] 无效日期显示原值
- [ ] 单元测试覆盖

#### T034-2: 日期时间格式化（开发者A，1.5h）
**描述**: 实现日期时间格式化
**验收标准**:
- [ ] 识别DATETIME类型列
- [ ] 格式化为yyyy-MM-dd HH:mm:ss
- [ ] 空值显示--
- [ ] 无效日期显示原值
- [ ] 单元测试覆盖

#### T034-3: 数字格式化（开发者A，1.5h）
**描述**: 实现数字格式化
**验收标准**:
- [ ] 识别NUMBER类型列
- [ ] 千分位分隔
- [ ] 保留2位小数
- [ ] 空值显示--
- [ ] 单元测试覆盖

#### T034-4: 货币格式化（开发者A，1.5h）
**描述**: 实现货币格式化
**验收标准**:
- [ ] 识别CURRENCY类型列
- [ ] 显示¥符号
- [ ] 千分位分隔
- [ ] 保留2位小数
- [ ] 空值显示--

#### T034-5: 列宽应用（开发者A，1h）
**描述**: 应用列配置的列宽
**验收标准**:
- [ ] 读取列配置width字段
- [ ] 应用到表格列
- [ ] 默认列宽150px
- [ ] 最小列宽50px
- [ ] 最大列宽500px

#### T034-6: 列显示/隐藏（开发者A，1h）
**描述**: 控制列显示
**验收标准**:
- [ ] 读取列配置visible字段
- [ ] visible=false的列不显示
- [ ] 至少保留一列可见
- [ ] 列顺序正确
- [ ] 动态列计算

#### T034-7: 格式化工具类（开发者A，2h）
**描述**: 创建格式化工具函数
**验收标准**:
- [ ] formatDate函数
- [ ] formatDateTime函数
- [ ] formatNumber函数
- [ ] formatCurrency函数
- [ ] 单元测试覆盖率>90%

#### T034-8: 格式化集成测试（开发者A，1.5h）
**描述**: 集成测试格式化功能
**验收标准**:
- [ ] 日期格式化测试通过
- [ ] 日期时间格式化测试通过
- [ ] 数字格式化测试通过
- [ ] 货币格式化测试通过
- [ ] 列宽应用测试通过
- [ ] E2E测试通过

---

## 📊 Sprint 2 进度跟踪

### 每日站会记录

| 日期 | 完成Story | 进行中Story | 阻碍问题 | 解决方案 |
|------|----------|------------|---------|---------|
| Day 1 |  |  |  |  |
| Day 2 |  |  |  |  |
| Day 3 |  |  |  |  |
| Day 4 |  |  |  |  |
| Day 5 |  |  |  |  |

### Sprint燃尽图

```
9人日 │                    ╲
      │                     ╲
      │                      ╲
      │                       ╲
      │                        ╲
      │                         ╲
      │                          ╲
      │                           ╲
      │                            ╲
   0  └─────────────────────────────╲
      Day1    Day2    Day3    Day4    Day5
```

---

## ✅ Sprint 2 完成标准

### Sprint目标达成
- [ ] 报表预览功能正常工作
- [ ] 权限配置功能完整
- [ ] SQL注入防护生效
- [ ] 列格式化正确显示

### 质量标准
- [ ] 单元测试覆盖率 > 80%
- [ ] SQL注入测试100%通过
- [ ] 代码审查通过
- [ ] 无P0/P1级别Bug

### 安全标准
- [ ] SQL注入防护测试通过
- [ ] 权限校验测试通过
- [ ] 安全审计日志正常
- [ ] 安全文档审查通过

---

*更新时间: 2026-01-15*  
*负责人: Scrum Master*
