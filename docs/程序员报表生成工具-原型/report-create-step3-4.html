<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºæŠ¥è¡¨ - Step 3-4 - ç¨‹åºå‘˜æŠ¥è¡¨ç”Ÿæˆå·¥å…·</title>
    <style>
        /* ========== CSSå˜é‡å®šä¹‰ ========== */
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --warning-color: #E6A23C;
            --danger-color: #F56C6C;
            --info-color: #909399;
            --border-radius: 4px;
            --box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
        }
        
        /* ========== å…¨å±€æ ·å¼ ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            font-size: 14px;
            color: #303133;
            background-color: #f0f2f5;
            line-height: 1.5;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }
        
        /* ========== é¡µé¢å¤´éƒ¨ ========== */
        .page-header {
            background: white;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .breadcrumb {
            color: #909399;
            font-size: 14px;
            margin-bottom: var(--spacing-sm);
        }
        
        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #303133;
        }
        
        /* ========== æ­¥éª¤æ¡æ ·å¼ ========== */
        .steps-container {
            background: white;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .step-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .step-item::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: #e4e7ed;
            z-index: 0;
        }
        
        .step-item:last-child::before {
            display: none;
        }
        
        .step-item.completed::before {
            background: var(--success-color);
        }
        
        .step-item.active::before {
            background: linear-gradient(to right, var(--success-color) 50%, #e4e7ed 50%);
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e4e7ed;
            color: #909399;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }
        
        .step-item.completed .step-icon {
            background: var(--success-color);
            color: white;
        }
        
        .step-item.active .step-icon {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 3px rgba(64, 158, 255, 0.2);
        }
        
        .step-title {
            margin-top: var(--spacing-sm);
            font-size: 14px;
            color: #909399;
        }
        
        .step-item.active .step-title {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .step-item.completed .step-title {
            color: #303133;
        }
        
        /* ========== è¡¨å•å®¹å™¨ ========== */
        .form-container {
            background: white;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .form-step {
            display: none;
        }
        
        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== è¡¨æ ¼æ ·å¼ ========== */
        .config-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-md);
        }
        
        .config-table thead {
            background: #fafafa;
        }
        
        .config-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #606266;
            border: 1px solid #EBEEF5;
            font-size: 13px;
        }
        
        .config-table td {
            padding: 8px;
            border: 1px solid #EBEEF5;
        }
        
        .config-table tbody tr:hover {
            background: #f5f7fa;
        }
        
        .config-table input[type="text"],
        .config-table input[type="number"],
        .config-table select,
        .config-table textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #DCDFE6;
            border-radius: 3px;
            font-size: 13px;
            transition: border-color 0.2s;
        }
        
        .config-table input:focus,
        .config-table select:focus,
        .config-table textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .config-table input.error {
            border-color: var(--danger-color);
        }
        
        /* ========== æŒ‰é’®æ ·å¼ ========== */
        .btn {
            padding: 9px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #66b1ff;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #85ce61;
        }
        
        .btn-default {
            background: white;
            color: #606266;
            border: 1px solid #DCDFE6;
        }
        
        .btn-default:hover:not(:disabled) {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background: #ecf5ff;
        }
        
        .btn-text {
            background: transparent;
            color: var(--primary-color);
            padding: 4px 8px;
            font-size: 13px;
        }
        
        .btn-text:hover:not(:disabled) {
            background: #ecf5ff;
        }
        
        .btn-text.btn-danger {
            color: var(--danger-color);
        }
        
        .btn-text.btn-danger:hover:not(:disabled) {
            background: #fef0f0;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* ========== å¼€å…³æ ·å¼ ========== */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #dcdfe6;
            transition: 0.2s;
            border-radius: 20px;
        }
        
        .switch-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.2s;
            border-radius: 50%;
        }
        
        .switch input:checked + .switch-slider {
            background-color: var(--primary-color);
        }
        
        .switch input:checked + .switch-slider:before {
            transform: translateX(20px);
        }
        
        /* ========== å¤é€‰æ¡†æ ·å¼ ========== */
        .checkbox {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        
        .checkbox input[type="checkbox"] {
            margin-right: 4px;
            cursor: pointer;
        }
        
        /* ========== æç¤ºæ¡†æ ·å¼ ========== */
        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .alert-info {
            background: #ecf5ff;
            color: #409eff;
            border: 1px solid #b3d8ff;
        }
        
        .alert-warning {
            background: #fdf6ec;
            color: #e6a23c;
            border: 1px solid #f5dab1;
        }
        
        /* ========== Toastæç¤º ========== */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            color: white;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }
        
        .toast-success { background: var(--success-color); }
        .toast-error { background: var(--danger-color); }
        .toast-warning { background: var(--warning-color); }
        .toast-info { background: var(--info-color); }
        
        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        /* ========== æ“ä½œæŒ‰é’®åŒºåŸŸ ========== */
        .form-footer {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding-top: var(--spacing-lg);
            border-top: 1px solid #EBEEF5;
            margin-top: var(--spacing-lg);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        /* ========== å·¥å…·æ  ========== */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .toolbar-title {
            font-size: 16px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- ========== åº”ç”¨å®¹å™¨ ========== -->
    <div class="app-container">
        
        <!-- ========== é¡µé¢å¤´éƒ¨ ========== -->
        <div class="page-header">
            <div class="breadcrumb">
                <a href="report-list.html">ğŸ“Š æŠ¥è¡¨åˆ—è¡¨</a> / <a href="report-create-step1-2.html">åˆ›å»ºæŠ¥è¡¨</a> / Step 3-4
            </div>
            <h1 class="page-title">åˆ›å»ºæ–°æŠ¥è¡¨ - å‚æ•°ä¸åˆ—é…ç½®</h1>
        </div>
        
        <!-- ========== æ­¥éª¤æ¡ ========== -->
        <div class="steps-container">
            <div class="steps">
                <div class="step-item completed" data-step="1">
                    <div class="step-icon">âœ“</div>
                    <div class="step-title">åŸºæœ¬ä¿¡æ¯</div>
                </div>
                <div class="step-item completed" data-step="2">
                    <div class="step-icon">âœ“</div>
                    <div class="step-title">SQLç¼–è¾‘</div>
                </div>
                <div class="step-item active" data-step="3">
                    <div class="step-icon">3</div>
                    <div class="step-title">å‚æ•°é…ç½®</div>
                </div>
                <div class="step-item" data-step="4">
                    <div class="step-icon">4</div>
                    <div class="step-title">åˆ—é…ç½®</div>
                </div>
            </div>
        </div>
        
        <!-- ========== è¡¨å•å®¹å™¨ ========== -->
        <div class="form-container">
            
            <!-- ========== Step 3: å‚æ•°é…ç½® ========== -->
            <div class="form-step active" id="step3">
                <div class="toolbar">
                    <h2 class="toolbar-title">âš™ï¸ Step 3: å‚æ•°é…ç½®</h2>
                    <button class="btn btn-primary btn-small" id="addParamBtn">
                        â• æ·»åŠ å‚æ•°
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <span>â„¹ï¸</span>
                    <div>
                        <strong>å‚æ•°é…ç½®è¯´æ˜ï¼š</strong><br>
                        1. SQLä¸­æ£€æµ‹åˆ° <strong id="detectedParamsCount">0</strong> ä¸ªå‚æ•°å ä½ç¬¦<br>
                        2. å‚æ•°åå¿…é¡»ä¸SQLä¸­çš„å ä½ç¬¦åŒ¹é…ï¼ˆå¦‚ :startDateï¼‰<br>
                        3. æœ€å¤šæ”¯æŒ20ä¸ªå‚æ•°<br>
                        4. å‚æ•°ç±»å‹ï¼šSTRINGï¼ˆæ–‡æœ¬ï¼‰ã€NUMBERï¼ˆæ•°å­—ï¼‰ã€DATEï¼ˆæ—¥æœŸï¼‰ã€DATETIMEï¼ˆæ—¥æœŸæ—¶é—´ï¼‰
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="config-table" id="paramTable">
                        <thead>
                            <tr>
                                <th style="width: 120px;">å‚æ•°å <span style="color: red;">*</span></th>
                                <th style="width: 120px;">å‚æ•°ç±»å‹ <span style="color: red;">*</span></th>
                                <th style="width: 150px;">é»˜è®¤å€¼</th>
                                <th style="width: 80px;">å¿…å¡«</th>
                                <th style="width: 200px;">å‚æ•°è¯´æ˜</th>
                                <th style="width: 100px;">æ’åº</th>
                                <th style="width: 80px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="paramTableBody">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyParamHint" style="text-align: center; padding: 40px 0; color: #909399;">
                    æš‚æ— å‚æ•°é…ç½®ï¼Œç‚¹å‡»"æ·»åŠ å‚æ•°"æŒ‰é’®å¼€å§‹é…ç½®
                </div>
            </div>
            
            <!-- ========== Step 4: åˆ—é…ç½® ========== -->
            <div class="form-step" id="step4">
                <div class="toolbar">
                    <h2 class="toolbar-title">ğŸ“‹ Step 4: åˆ—é…ç½®</h2>
                    <div class="btn-group">
                        <button class="btn btn-default btn-small" id="showAllBtn">
                            ğŸ‘ï¸ å…¨éƒ¨æ˜¾ç¤º
                        </button>
                        <button class="btn btn-default btn-small" id="hideAllBtn">
                            ğŸ™ˆ å…¨éƒ¨éšè—
                        </button>
                        <button class="btn btn-primary btn-small" id="extractColumnsBtn">
                            ğŸ”„ è‡ªåŠ¨æå–åˆ—ä¿¡æ¯
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <span>â„¹ï¸</span>
                    <div>
                        <strong>åˆ—é…ç½®è¯´æ˜ï¼š</strong><br>
                        1. ç‚¹å‡»"è‡ªåŠ¨æå–åˆ—ä¿¡æ¯"ä»SQLæ‰§è¡Œç»“æœä¸­æå–åˆ—ä¿¡æ¯<br>
                        2. é…ç½®æ¯åˆ—çš„æ˜¾ç¤ºåç§°ã€åˆ—å®½ã€æ ¼å¼åŒ–ç±»å‹å’Œæ˜¾ç¤ºçŠ¶æ€<br>
                        3. æ ¼å¼åŒ–ç±»å‹ï¼šDEFAULTï¼ˆåŸå§‹å€¼ï¼‰ã€DATEï¼ˆæ—¥æœŸæ ¼å¼ï¼‰ã€NUMBERï¼ˆæ•°å­—æ ¼å¼ï¼‰ã€CURRENCYï¼ˆè´§å¸æ ¼å¼ï¼‰
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="config-table" id="columnTable">
                        <thead>
                            <tr>
                                <th style="width: 120px;">å­—æ®µå</th>
                                <th style="width: 150px;">æ˜¾ç¤ºåç§° <span style="color: red;">*</span></th>
                                <th style="width: 100px;">åˆ—å®½(px)</th>
                                <th style="width: 120px;">æ ¼å¼åŒ–ç±»å‹</th>
                                <th style="width: 80px;">æ˜¾ç¤º/éšè—</th>
                                <th style="width: 100px;">æ’åº</th>
                            </tr>
                        </thead>
                        <tbody id="columnTableBody">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyColumnHint" style="text-align: center; padding: 40px 0; color: #909399;">
                    ç‚¹å‡»"è‡ªåŠ¨æå–åˆ—ä¿¡æ¯"æŒ‰é’®ä»SQLæ‰§è¡Œç»“æœä¸­æå–åˆ—ä¿¡æ¯
                </div>
            </div>
            
            <!-- ========== æ“ä½œæŒ‰é’®åŒºåŸŸ ========== -->
            <div class="form-footer">
                <div>
                    <button class="btn btn-default" id="backToStep2Btn">
                        â† è¿”å›Step 2
                    </button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-default" id="prevBtn" style="display: none;">
                        â† ä¸Šä¸€æ­¥
                    </button>
                    <button class="btn btn-primary" id="nextBtn">
                        ä¸‹ä¸€æ­¥ â†’
                    </button>
                    <button class="btn btn-success" id="saveReportBtn" style="display: none;">
                        ğŸ’¾ ä¿å­˜æŠ¥è¡¨
                    </button>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- ========== Toastå®¹å™¨ ========== -->
    <div id="toastContainer"></div>
    
    <script>
        // ========================================
        // å…¨å±€çŠ¶æ€ç®¡ç†
        // ========================================
        
        let currentStep = 3;
        let reportData = {
            reportName: '',
            reportDesc: '',
            sqlContent: '',
            params: [],
            columns: []
        };
        
        // ä»localStorageåŠ è½½è‰ç¨¿
        const draftData = localStorage.getItem('reportDraft');
        if (draftData) {
            reportData = JSON.parse(draftData);
        }
        
        // æ¨¡æ‹Ÿä»SQLä¸­æå–çš„å‚æ•°
        const detectedParams = ['startDate', 'endDate', 'status'];
        
        // ========================================
        // å·¥å…·å‡½æ•°
        // ========================================
        
        /**
         * æ˜¾ç¤ºToastæç¤º
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        /**
         * ä¿å­˜è‰ç¨¿åˆ°localStorage
         */
        function saveDraft() {
            localStorage.setItem('reportDraft', JSON.stringify(reportData));
        }
        
        /**
         * ç”Ÿæˆå”¯ä¸€ID
         */
        function generateId() {
            return Date.now() + Math.random();
        }
        
        // ========================================
        // æ­¥éª¤åˆ‡æ¢å‡½æ•°
        // ========================================
        
        /**
         * åˆ‡æ¢åˆ°æŒ‡å®šæ­¥éª¤
         */
        function switchStep(step) {
            document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-item').forEach(el => {
                el.classList.remove('active', 'completed');
            });
            
            document.getElementById(`step${step}`).classList.add('active');
            
            document.querySelectorAll('.step-item').forEach((el, index) => {
                const stepNum = index + 1;
                if (stepNum < step) {
                    el.classList.add('completed');
                    el.querySelector('.step-icon').textContent = 'âœ“';
                } else if (stepNum === step) {
                    el.classList.add('active');
                    el.querySelector('.step-icon').textContent = stepNum;
                } else {
                    el.querySelector('.step-icon').textContent = stepNum;
                }
            });
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            document.getElementById('prevBtn').style.display = step === 4 ? 'inline-flex' : 'none';
            document.getElementById('nextBtn').style.display = step === 3 ? 'inline-flex' : 'none';
            document.getElementById('saveReportBtn').style.display = step === 4 ? 'inline-flex' : 'none';
            
            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ========================================
        // å‚æ•°é…ç½®å‡½æ•°
        // ========================================
        
        /**
         * æ·»åŠ å‚æ•°è¡Œ
         */
        function addParam(paramName = '', paramType = 'STRING', defaultValue = '', isRequired = false, desc = '') {
            if (reportData.params.length >= 20) {
                showToast('å‚æ•°æ•°é‡ä¸èƒ½è¶…è¿‡20ä¸ª', 'warning');
                return;
            }
            
            const param = {
                id: generateId(),
                paramName,
                paramType,
                defaultValue,
                isRequired,
                desc,
                sortOrder: reportData.params.length
            };
            
            reportData.params.push(param);
            renderParamTable();
            saveDraft();
            
            if (paramName) {
                showToast(`å·²æ·»åŠ å‚æ•°: ${paramName}`, 'success', 2000);
            }
        }
        
        /**
         * åˆ é™¤å‚æ•°
         */
        function deleteParam(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å‚æ•°å—ï¼Ÿ')) {
                reportData.params = reportData.params.filter(p => p.id !== id);
                renderParamTable();
                saveDraft();
                showToast('å‚æ•°å·²åˆ é™¤', 'success');
            }
        }
        
        /**
         * ä¸Šç§»å‚æ•°
         */
        function moveParamUp(id) {
            const index = reportData.params.findIndex(p => p.id === id);
            if (index > 0) {
                [reportData.params[index], reportData.params[index - 1]] = 
                [reportData.params[index - 1], reportData.params[index]];
                renderParamTable();
                saveDraft();
            }
        }
        
        /**
         * ä¸‹ç§»å‚æ•°
         */
        function moveParamDown(id) {
            const index = reportData.params.findIndex(p => p.id === id);
            if (index < reportData.params.length - 1) {
                [reportData.params[index], reportData.params[index + 1]] = 
                [reportData.params[index + 1], reportData.params[index]];
                renderParamTable();
                saveDraft();
            }
        }
        
        /**
         * æ¸²æŸ“å‚æ•°è¡¨æ ¼
         */
        function renderParamTable() {
            const tbody = document.getElementById('paramTableBody');
            const emptyHint = document.getElementById('emptyParamHint');
            
            if (reportData.params.length === 0) {
                tbody.innerHTML = '';
                emptyHint.style.display = 'block';
                return;
            }
            
            emptyHint.style.display = 'none';
            
            tbody.innerHTML = reportData.params.map((param, index) => `
                <tr data-id="${param.id}">
                    <td>
                        <input type="text" value="${param.paramName}" 
                               onchange="updateParam(${param.id}, 'paramName', this.value)"
                               placeholder="å‚æ•°å">
                    </td>
                    <td>
                        <select onchange="updateParam(${param.id}, 'paramType', this.value)">
                            <option value="STRING" ${param.paramType === 'STRING' ? 'selected' : ''}>STRING</option>
                            <option value="NUMBER" ${param.paramType === 'NUMBER' ? 'selected' : ''}>NUMBER</option>
                            <option value="DATE" ${param.paramType === 'DATE' ? 'selected' : ''}>DATE</option>
                            <option value="DATETIME" ${param.paramType === 'DATETIME' ? 'selected' : ''}>DATETIME</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" value="${param.defaultValue}" 
                               onchange="updateParam(${param.id}, 'defaultValue', this.value)"
                               placeholder="é»˜è®¤å€¼">
                    </td>
                    <td style="text-align: center;">
                        <label class="checkbox">
                            <input type="checkbox" ${param.isRequired ? 'checked' : ''}
                                   onchange="updateParam(${param.id}, 'isRequired', this.checked)">
                        </label>
                    </td>
                    <td>
                        <input type="text" value="${param.desc}" 
                               onchange="updateParam(${param.id}, 'desc', this.value)"
                               placeholder="å‚æ•°è¯´æ˜">
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-text btn-small" 
                                onclick="moveParamUp(${param.id})"
                                ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="btn btn-text btn-small" 
                                onclick="moveParamDown(${param.id})"
                                ${index === reportData.params.length - 1 ? 'disabled' : ''}>â†“</button>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-text btn-danger btn-small" 
                                onclick="deleteParam(${param.id})">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }
        
        /**
         * æ›´æ–°å‚æ•°
         */
        function updateParam(id, field, value) {
            const param = reportData.params.find(p => p.id === id);
            if (param) {
                param[field] = value;
                saveDraft();
            }
        }
        
        // ========================================
        // åˆ—é…ç½®å‡½æ•°
        // ========================================
        
        /**
         * è‡ªåŠ¨æå–åˆ—ä¿¡æ¯
         */
        function extractColumns() {
            const btn = document.getElementById('extractColumnsBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ æå–ä¸­...';
            
            // æ¨¡æ‹Ÿæå–åˆ—ä¿¡æ¯
            setTimeout(() => {
                const mockColumns = [
                    { fieldName: 'user_id', dataType: 'INTEGER' },
                    { fieldName: 'username', dataType: 'VARCHAR' },
                    { fieldName: 'email', dataType: 'VARCHAR' },
                    { fieldName: 'created_at', dataType: 'TIMESTAMP' },
                    { fieldName: 'total_amount', dataType: 'DECIMAL' }
                ];
                
                reportData.columns = mockColumns.map((col, index) => ({
                    id: generateId(),
                    fieldName: col.fieldName,
                    displayName: col.fieldName,
                    columnWidth: 100,
                    formatType: col.dataType === 'TIMESTAMP' ? 'DATE' : 
                                (col.dataType === 'DECIMAL' || col.dataType === 'INTEGER') ? 'NUMBER' : 
                                col.fieldName.includes('amount') || col.fieldName.includes('price') ? 'CURRENCY' : 'DEFAULT',
                    isVisible: true,
                    sortOrder: index
                }));
                
                renderColumnTable();
                saveDraft();
                showToast(`å·²æå–${mockColumns.length}åˆ—ä¿¡æ¯`, 'success');
                
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ è‡ªåŠ¨æå–åˆ—ä¿¡æ¯';
            }, 1500);
        }
        
        /**
         * æ¸²æŸ“åˆ—é…ç½®è¡¨æ ¼
         */
        function renderColumnTable() {
            const tbody = document.getElementById('columnTableBody');
            const emptyHint = document.getElementById('emptyColumnHint');
            
            if (reportData.columns.length === 0) {
                tbody.innerHTML = '';
                emptyHint.style.display = 'block';
                return;
            }
            
            emptyHint.style.display = 'none';
            
            tbody.innerHTML = reportData.columns.map((col, index) => `
                <tr data-id="${col.id}">
                    <td><strong>${col.fieldName}</strong></td>
                    <td>
                        <input type="text" value="${col.displayName}" 
                               onchange="updateColumn(${col.id}, 'displayName', this.value)"
                               placeholder="æ˜¾ç¤ºåç§°">
                    </td>
                    <td>
                        <input type="number" value="${col.columnWidth}" min="50" max="500"
                               onchange="updateColumn(${col.id}, 'columnWidth', parseInt(this.value))"
                               style="text-align: center;">
                    </td>
                    <td>
                        <select onchange="updateColumn(${col.id}, 'formatType', this.value)">
                            <option value="DEFAULT" ${col.formatType === 'DEFAULT' ? 'selected' : ''}>DEFAULT</option>
                            <option value="DATE" ${col.formatType === 'DATE' ? 'selected' : ''}>DATE</option>
                            <option value="NUMBER" ${col.formatType === 'NUMBER' ? 'selected' : ''}>NUMBER</option>
                            <option value="CURRENCY" ${col.formatType === 'CURRENCY' ? 'selected' : ''}>CURRENCY</option>
                        </select>
                    </td>
                    <td style="text-align: center;">
                        <label class="switch">
                            <input type="checkbox" ${col.isVisible ? 'checked' : ''}
                                   onchange="updateColumn(${col.id}, 'isVisible', this.checked)">
                            <span class="switch-slider"></span>
                        </label>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-text btn-small" 
                                onclick="moveColumnUp(${col.id})"
                                ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="btn btn-text btn-small" 
                                onclick="moveColumnDown(${col.id})"
                                ${index === reportData.columns.length - 1 ? 'disabled' : ''}>â†“</button>
                    </td>
                </tr>
            `).join('');
        }
        
        /**
         * æ›´æ–°åˆ—é…ç½®
         */
        function updateColumn(id, field, value) {
            const column = reportData.columns.find(c => c.id === id);
            if (column) {
                column[field] = value;
                saveDraft();
            }
        }
        
        /**
         * ä¸Šç§»åˆ—
         */
        function moveColumnUp(id) {
            const index = reportData.columns.findIndex(c => c.id === id);
            if (index > 0) {
                [reportData.columns[index], reportData.columns[index - 1]] = 
                [reportData.columns[index - 1], reportData.columns[index]];
                renderColumnTable();
                saveDraft();
            }
        }
        
        /**
         * ä¸‹ç§»åˆ—
         */
        function moveColumnDown(id) {
            const index = reportData.columns.findIndex(c => c.id === id);
            if (index < reportData.columns.length - 1) {
                [reportData.columns[index], reportData.columns[index + 1]] = 
                [reportData.columns[index + 1], reportData.columns[index]];
                renderColumnTable();
                saveDraft();
            }
        }
        
        /**
         * å…¨éƒ¨æ˜¾ç¤º
         */
        function showAllColumns() {
            reportData.columns.forEach(col => col.isVisible = true);
            renderColumnTable();
            saveDraft();
            showToast('å·²æ˜¾ç¤ºæ‰€æœ‰åˆ—', 'success');
        }
        
        /**
         * å…¨éƒ¨éšè—
         */
        function hideAllColumns() {
            reportData.columns.forEach(col => col.isVisible = false);
            renderColumnTable();
            saveDraft();
            showToast('å·²éšè—æ‰€æœ‰åˆ—', 'warning');
        }
        
        // ========================================
        // äº‹ä»¶å¤„ç†å‡½æ•°
        // ========================================
        
        /**
         * ä¸‹ä¸€æ­¥
         */
        function handleNext() {
            if (currentStep === 3) {
                switchStep(4);
            }
        }
        
        /**
         * ä¸Šä¸€æ­¥
         */
        function handlePrev() {
            if (currentStep === 4) {
                switchStep(3);
            }
        }
        
        /**
         * è¿”å›Step 2
         */
        function backToStep2() {
            if (confirm('è¿”å›Step 2å°†ä¿ç•™å½“å‰é…ç½®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                window.location.href = 'report-create-step1-2.html';
            }
        }
        
        /**
         * ä¿å­˜æŠ¥è¡¨
         */
        function saveReport() {
            // éªŒè¯å¿…å¡«é¡¹
            if (reportData.columns.length === 0) {
                showToast('è¯·å…ˆé…ç½®åˆ—ä¿¡æ¯', 'warning');
                return;
            }
            
            const visibleColumns = reportData.columns.filter(c => c.isVisible);
            if (visibleColumns.length === 0) {
                if (!confirm('æ‰€æœ‰åˆ—éƒ½å·²éšè—ï¼Œç”¨æˆ·å°†æ— æ³•æŸ¥çœ‹æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ä¿å­˜ï¼Ÿ')) {
                    return;
                }
            }
            
            const btn = document.getElementById('saveReportBtn');
            btn.disabled = true;
            btn.innerHTML = 'ğŸ’¾ ä¿å­˜ä¸­...';
            
            // æ¨¡æ‹Ÿä¿å­˜
            setTimeout(() => {
                showToast('æŠ¥è¡¨ä¿å­˜æˆåŠŸï¼', 'success');
                localStorage.removeItem('reportDraft');
                
                setTimeout(() => {
                    window.location.href = 'report-list.html';
                }, 1500);
            }, 2000);
        }
        
        // ========================================
        // é¡µé¢åˆå§‹åŒ–
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„å‚æ•°æ•°é‡
            document.getElementById('detectedParamsCount').textContent = detectedParams.length;
            
            // å¦‚æœæœ‰æ£€æµ‹åˆ°çš„å‚æ•°ä½†æœªé…ç½®ï¼Œè‡ªåŠ¨æ·»åŠ 
            if (reportData.params.length === 0 && detectedParams.length > 0) {
                detectedParams.forEach(paramName => {
                    addParam(paramName, 'STRING', '', false, '');
                });
            } else {
                renderParamTable();
            }
            
            // æ¸²æŸ“åˆ—é…ç½®
            renderColumnTable();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('addParamBtn').addEventListener('click', () => addParam());
            document.getElementById('extractColumnsBtn').addEventListener('click', extractColumns);
            document.getElementById('showAllBtn').addEventListener('click', showAllColumns);
            document.getElementById('hideAllBtn').addEventListener('click', hideAllColumns);
            document.getElementById('nextBtn').addEventListener('click', handleNext);
            document.getElementById('prevBtn').addEventListener('click', handlePrev);
            document.getElementById('backToStep2Btn').addEventListener('click', backToStep2);
            document.getElementById('saveReportBtn').addEventListener('click', saveReport);
        });
    </script>
</body>
</html>