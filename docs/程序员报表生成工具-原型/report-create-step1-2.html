<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºæŠ¥è¡¨ - Step 1-2 - ç¨‹åºå‘˜æŠ¥è¡¨ç”Ÿæˆå·¥å…·</title>
    <style>
        /* ========== CSSå˜é‡å®šä¹‰ ========== */
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --warning-color: #E6A23C;
            --danger-color: #F56C6C;
            --info-color: #909399;
            --border-radius: 4px;
            --box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
        }
        
        /* ========== å…¨å±€æ ·å¼ ========== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            font-size: 14px;
            color: #303133;
            background-color: #f0f2f5;
            line-height: 1.5;
        }
        
        /* ========== å¸ƒå±€å®¹å™¨ ========== */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }
        
        /* ========== é¡µé¢å¤´éƒ¨ ========== */
        .page-header {
            background: white;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .breadcrumb {
            color: #909399;
            font-size: 14px;
            margin-bottom: var(--spacing-sm);
        }
        
        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            color: #66b1ff;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #303133;
        }
        
        /* ========== æ­¥éª¤æ¡æ ·å¼ ========== */
        .steps-container {
            background: white;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .step-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .step-item::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: #e4e7ed;
            z-index: 0;
        }
        
        .step-item:last-child::before {
            display: none;
        }
        
        .step-item.completed::before {
            background: var(--success-color);
        }
        
        .step-item.active::before {
            background: linear-gradient(to right, var(--success-color) 50%, #e4e7ed 50%);
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e4e7ed;
            color: #909399;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }
        
        .step-item.completed .step-icon {
            background: var(--success-color);
            color: white;
        }
        
        .step-item.active .step-icon {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 3px rgba(64, 158, 255, 0.2);
        }
        
        .step-title {
            margin-top: var(--spacing-sm);
            font-size: 14px;
            color: #909399;
        }
        
        .step-item.active .step-title {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .step-item.completed .step-title {
            color: #303133;
        }
        
        /* ========== è¡¨å•å®¹å™¨ ========== */
        .form-container {
            background: white;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .form-step {
            display: none;
        }
        
        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: #606266;
        }
        
        .form-label.required::before {
            content: '* ';
            color: var(--danger-color);
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #DCDFE6;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-input.error {
            border-color: var(--danger-color);
        }
        
        .form-input.success {
            border-color: var(--success-color);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-help {
            margin-top: 4px;
            font-size: 12px;
            color: #909399;
        }
        
        .form-error {
            margin-top: 4px;
            font-size: 12px;
            color: var(--danger-color);
            display: none;
        }
        
        .form-error.show {
            display: block;
        }
        
        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #909399;
            margin-top: 4px;
        }
        
        .char-counter.warning {
            color: var(--warning-color);
        }
        
        /* ========== SQLç¼–è¾‘å™¨æ ·å¼ ========== */
        .sql-editor-container {
            position: relative;
        }
        
        .sql-editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }
        
        .sql-editor {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            border: 1px solid #DCDFE6;
            border-radius: var(--border-radius);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: #f5f7fa;
            color: #303133;
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        .sql-editor:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
        }
        
        .sql-keyword {
            color: #c678dd;
            font-weight: 600;
        }
        
        .sql-param {
            color: #e06c75;
        }
        
        /* ========== æŒ‰é’®æ ·å¼ ========== */
        .btn {
            padding: 9px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #66b1ff;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #85ce61;
        }
        
        .btn-default {
            background: white;
            color: #606266;
            border: 1px solid #DCDFE6;
        }
        
        .btn-default:hover:not(:disabled) {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background: #ecf5ff;
        }
        
        .btn-info {
            background: var(--info-color);
            color: white;
        }
        
        .btn-info:hover:not(:disabled) {
            background: #a6a9ad;
        }
        
        .btn-loading::before {
            content: 'â³ ';
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* ========== æ“ä½œæŒ‰é’®åŒºåŸŸ ========== */
        .form-footer {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding-top: var(--spacing-lg);
            border-top: 1px solid #EBEEF5;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        /* ========== Toastæç¤º ========== */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            color: white;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }
        
        .toast-success { background: var(--success-color); }
        .toast-error { background: var(--danger-color); }
        .toast-warning { background: var(--warning-color); }
        .toast-info { background: var(--info-color); }
        
        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        /* ========== æç¤ºæ¡†æ ·å¼ ========== */
        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .alert-info {
            background: #ecf5ff;
            color: #409eff;
            border: 1px solid #b3d8ff;
        }
        
        .alert-success {
            background: #f0f9ff;
            color: #67c23a;
            border: 1px solid #b3e19d;
        }
        
        .alert-error {
            background: #fef0f0;
            color: #f56c6c;
            border: 1px solid #fbc4c4;
        }
        
        /* ========== å‚æ•°æå–ç»“æœ ========== */
        .param-list {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: #f5f7fa;
            border-radius: var(--border-radius);
        }
        
        .param-item {
            display: inline-block;
            padding: 4px 12px;
            margin: 4px;
            background: white;
            border: 1px solid #DCDFE6;
            border-radius: 12px;
            font-size: 12px;
            color: #606266;
        }
    </style>
</head>
<body>
    <!-- ========== åº”ç”¨å®¹å™¨ ========== -->
    <div class="app-container">
        
        <!-- ========== é¡µé¢å¤´éƒ¨ ========== -->
        <div class="page-header">
            <div class="breadcrumb">
                <a href="report-list.html">ğŸ“Š æŠ¥è¡¨åˆ—è¡¨</a> / åˆ›å»ºæŠ¥è¡¨
            </div>
            <h1 class="page-title">åˆ›å»ºæ–°æŠ¥è¡¨</h1>
        </div>
        
        <!-- ========== æ­¥éª¤æ¡ ========== -->
        <div class="steps-container">
            <div class="steps">
                <div class="step-item active" data-step="1">
                    <div class="step-icon">1</div>
                    <div class="step-title">åŸºæœ¬ä¿¡æ¯</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-icon">2</div>
                    <div class="step-title">SQLç¼–è¾‘</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-icon">3</div>
                    <div class="step-title">å‚æ•°é…ç½®</div>
                </div>
                <div class="step-item" data-step="4">
                    <div class="step-icon">4</div>
                    <div class="step-title">åˆ—é…ç½®</div>
                </div>
            </div>
        </div>
        
        <!-- ========== è¡¨å•å®¹å™¨ ========== -->
        <div class="form-container">
            
            <!-- ========== Step 1: åŸºæœ¬ä¿¡æ¯ ========== -->
            <div class="form-step active" id="step1">
                <h2 style="margin-bottom: 24px; font-size: 18px;">ğŸ“ Step 1: åŸºæœ¬ä¿¡æ¯é…ç½®</h2>
                
                <div class="form-group">
                    <label class="form-label required">æŠ¥è¡¨åç§°</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="reportName"
                        placeholder="è¯·è¾“å…¥æŠ¥è¡¨åç§°ï¼ˆ2-50ä¸ªå­—ç¬¦ï¼‰"
                        maxlength="50"
                    >
                    <div class="form-error" id="reportNameError"></div>
                    <div class="char-counter" id="reportNameCounter">0 / 50</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æŠ¥è¡¨æè¿°</label>
                    <textarea 
                        class="form-input form-textarea" 
                        id="reportDesc"
                        placeholder="è¯·è¾“å…¥æŠ¥è¡¨æè¿°ï¼Œè¯´æ˜æŠ¥è¡¨çš„ç”¨é€”å’Œä¸šåŠ¡åœºæ™¯ï¼ˆé€‰å¡«ï¼Œæœ€å¤š500å­—ç¬¦ï¼‰"
                        maxlength="500"
                    ></textarea>
                    <div class="form-help">æè¿°æŠ¥è¡¨çš„ç”¨é€”ã€æ•°æ®æ¥æºå’Œä½¿ç”¨åœºæ™¯</div>
                    <div class="char-counter" id="reportDescCounter">0 / 500</div>
                </div>
            </div>
            
            <!-- ========== Step 2: SQLç¼–è¾‘ ========== -->
            <div class="form-step" id="step2">
                <h2 style="margin-bottom: 24px; font-size: 18px;">ğŸ’» Step 2: SQLæŸ¥è¯¢è¯­å¥</h2>
                
                <div class="alert alert-info">
                    <span>â„¹ï¸</span>
                    <div>
                        <strong>SQLç¼–å†™è¯´æ˜ï¼š</strong><br>
                        1. ä»…æ”¯æŒ SELECT æŸ¥è¯¢è¯­å¥<br>
                        2. å‚æ•°ä½¿ç”¨ <code>:paramName</code> æ ¼å¼ï¼Œå¦‚ <code>WHERE created_at >= :startDate</code><br>
                        3. å­—ç¬¦æ•°é™åˆ¶ï¼š1-10000å­—ç¬¦<br>
                        4. ä¿å­˜å‰å¿…é¡»æµ‹è¯•æ‰§è¡ŒæˆåŠŸ
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="sql-editor-toolbar">
                        <label class="form-label required" style="margin-bottom: 0;">SQLæŸ¥è¯¢è¯­å¥</label>
                        <div>
                            <button class="btn btn-success" id="testExecuteBtn">
                                â–¶ï¸ æµ‹è¯•æ‰§è¡Œ
                            </button>
                        </div>
                    </div>
                    
                    <textarea 
                        class="form-input sql-editor" 
                        id="sqlContent"
                        placeholder="-- è¯·è¾“å…¥SELECTæŸ¥è¯¢è¯­å¥&#10;-- ç¤ºä¾‹ï¼š&#10;SELECT &#10;    user_id,&#10;    username,&#10;    created_at&#10;FROM users&#10;WHERE created_at >= :startDate&#10;  AND created_at <= :endDate&#10;ORDER BY created_at DESC&#10;LIMIT 100;"
                    ></textarea>
                    <div class="form-error" id="sqlContentError"></div>
                    <div class="char-counter" id="sqlContentCounter">0 / 10000</div>
                </div>
                
                <!-- æµ‹è¯•æ‰§è¡Œç»“æœ -->
                <div id="testResultContainer" style="display: none;"></div>
                
                <!-- å‚æ•°æå–ç»“æœ -->
                <div id="paramExtractContainer" style="display: none;">
                    <div class="alert alert-success">
                        <span>âœ…</span>
                        <div>
                            <strong>å·²æ£€æµ‹åˆ°å‚æ•°å ä½ç¬¦ï¼š</strong>
                            <div class="param-list" id="paramList"></div>
                            è¿™äº›å‚æ•°å°†åœ¨Step 3ä¸­è¿›è¡Œé…ç½®
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== æ“ä½œæŒ‰é’®åŒºåŸŸ ========== -->
            <div class="form-footer">
                <div>
                    <button class="btn btn-default" id="cancelBtn">
                        âŒ å–æ¶ˆ
                    </button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-info" id="saveDraftBtn">
                        ğŸ’¾ ä¿å­˜è‰ç¨¿
                    </button>
                    <button class="btn btn-default" id="prevBtn" style="display: none;">
                        â† ä¸Šä¸€æ­¥
                    </button>
                    <button class="btn btn-primary" id="nextBtn">
                        ä¸‹ä¸€æ­¥ â†’
                    </button>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- ========== Toastå®¹å™¨ ========== -->
    <div id="toastContainer"></div>
    
    <script>
        // ========================================
        // å…¨å±€çŠ¶æ€ç®¡ç†
        // ========================================
        
        let currentStep = 1;
        let reportData = {
            reportName: '',
            reportDesc: '',
            sqlContent: '',
            params: [],
            testExecuted: false
        };
        
        // ä»localStorageåŠ è½½è‰ç¨¿
        const draftData = localStorage.getItem('reportDraft');
        if (draftData) {
            reportData = JSON.parse(draftData);
            showToast('å·²æ¢å¤è‰ç¨¿æ•°æ®', 'info');
        }
        
        // ========================================
        // å·¥å…·å‡½æ•°
        // ========================================
        
        /**
         * æ˜¾ç¤ºToastæç¤º
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        /**
         * ä¿å­˜è‰ç¨¿åˆ°localStorage
         */
        function saveDraft() {
            localStorage.setItem('reportDraft', JSON.stringify(reportData));
        }
        
        /**
         * é˜²æŠ–å‡½æ•°
         */
        function debounce(fn, delay) {
            let timer = null;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }
        
        // ========================================
        // æ­¥éª¤åˆ‡æ¢å‡½æ•°
        // ========================================
        
        /**
         * åˆ‡æ¢åˆ°æŒ‡å®šæ­¥éª¤
         */
        function switchStep(step) {
            // éšè—æ‰€æœ‰æ­¥éª¤
            document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-item').forEach(el => {
                el.classList.remove('active', 'completed');
            });
            
            // æ˜¾ç¤ºå½“å‰æ­¥éª¤
            document.getElementById(`step${step}`).classList.add('active');
            
            // æ›´æ–°æ­¥éª¤æ¡çŠ¶æ€
            document.querySelectorAll('.step-item').forEach((el, index) => {
                const stepNum = index + 1;
                if (stepNum < step) {
                    el.classList.add('completed');
                    el.querySelector('.step-icon').textContent = 'âœ“';
                } else if (stepNum === step) {
                    el.classList.add('active');
                    el.querySelector('.step-icon').textContent = stepNum;
                } else {
                    el.querySelector('.step-icon').textContent = stepNum;
                }
            });
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            document.getElementById('prevBtn').style.display = step > 1 ? 'inline-flex' : 'none';
            
            currentStep = step;
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ========================================
        // è¡¨å•éªŒè¯å‡½æ•°
        // ========================================
        
        /**
         * éªŒè¯Step 1
         */
        function validateStep1() {
            const reportName = document.getElementById('reportName').value.trim();
            const reportNameError = document.getElementById('reportNameError');
            const reportNameInput = document.getElementById('reportName');
            
            if (!reportName) {
                reportNameError.textContent = 'æŠ¥è¡¨åç§°ä¸èƒ½ä¸ºç©º';
                reportNameError.classList.add('show');
                reportNameInput.classList.add('error');
                return false;
            }
            
            if (reportName.length < 2) {
                reportNameError.textContent = 'æŠ¥è¡¨åç§°è‡³å°‘2ä¸ªå­—ç¬¦';
                reportNameError.classList.add('show');
                reportNameInput.classList.add('error');
                return false;
            }
            
            reportNameError.classList.remove('show');
            reportNameInput.classList.remove('error');
            reportNameInput.classList.add('success');
            
            reportData.reportName = reportName;
            reportData.reportDesc = document.getElementById('reportDesc').value.trim();
            
            return true;
        }
        
        /**
         * éªŒè¯Step 2
         */
        function validateStep2() {
            const sqlContent = document.getElementById('sqlContent').value.trim();
            const sqlContentError = document.getElementById('sqlContentError');
            const sqlContentInput = document.getElementById('sqlContent');
            
            if (!sqlContent) {
                sqlContentError.textContent = 'SQLæŸ¥è¯¢è¯­å¥ä¸èƒ½ä¸ºç©º';
                sqlContentError.classList.add('show');
                sqlContentInput.classList.add('error');
                return false;
            }
            
            if (!sqlContent.toUpperCase().includes('SELECT')) {
                sqlContentError.textContent = 'ä»…æ”¯æŒSELECTæŸ¥è¯¢è¯­å¥';
                sqlContentError.classList.add('show');
                sqlContentInput.classList.add('error');
                return false;
            }
            
            if (!reportData.testExecuted) {
                sqlContentError.textContent = 'è¯·å…ˆæµ‹è¯•æ‰§è¡ŒSQL';
                sqlContentError.classList.add('show');
                sqlContentInput.classList.add('error');
                showToast('ä¿å­˜å‰å¿…é¡»æµ‹è¯•æ‰§è¡ŒæˆåŠŸ', 'warning');
                return false;
            }
            
            sqlContentError.classList.remove('show');
            sqlContentInput.classList.remove('error');
            sqlContentInput.classList.add('success');
            
            reportData.sqlContent = sqlContent;
            
            return true;
        }
        
        // ========================================
        // SQLç›¸å…³å‡½æ•°
        // ========================================
        
        /**
         * æå–SQLä¸­çš„å‚æ•°
         */
        function extractParams(sql) {
            const regex = /:([a-zA-Z_][a-zA-Z0-9_]*)/g;
            const params = new Set();
            let match;
            
            while ((match = regex.exec(sql)) !== null) {
                params.add(match[1]);
            }
            
            return Array.from(params);
        }
        
        /**
         * æµ‹è¯•æ‰§è¡ŒSQL
         */
        function testExecuteSQL() {
            const sqlContent = document.getElementById('sqlContent').value.trim();
            
            if (!sqlContent) {
                showToast('è¯·å…ˆè¾“å…¥SQLæŸ¥è¯¢è¯­å¥', 'warning');
                return;
            }
            
            if (!sqlContent.toUpperCase().includes('SELECT')) {
                showToast('ä»…æ”¯æŒSELECTæŸ¥è¯¢è¯­å¥', 'error');
                return;
            }
            
            const testBtn = document.getElementById('testExecuteBtn');
            testBtn.disabled = true;
            testBtn.classList.add('btn-loading');
            testBtn.textContent = 'æ‰§è¡Œä¸­...';
            
            // æ¨¡æ‹Ÿæµ‹è¯•æ‰§è¡Œ
            setTimeout(() => {
                const success = Math.random() > 0.3; // 70%æˆåŠŸç‡
                const resultContainer = document.getElementById('testResultContainer');
                
                if (success) {
                    // æå–å‚æ•°
                    const params = extractParams(sqlContent);
                    reportData.params = params;
                    reportData.testExecuted = true;
                    
                    resultContainer.innerHTML = `
                        <div class="alert alert-success">
                            <span>âœ…</span>
                            <div>
                                <strong>æµ‹è¯•æ‰§è¡ŒæˆåŠŸ</strong><br>
                                æ‰§è¡Œæ—¶é—´: 1.23ç§’ | ç»“æœè¡Œæ•°: 42è¡Œï¼ˆé¢„è§ˆå‰100è¡Œï¼‰
                            </div>
                        </div>
                    `;
                    resultContainer.style.display = 'block';
                    
                    // æ˜¾ç¤ºå‚æ•°æå–ç»“æœ
                    if (params.length > 0) {
                        const paramContainer = document.getElementById('paramExtractContainer');
                        const paramList = document.getElementById('paramList');
                        paramList.innerHTML = params.map(p => 
                            `<span class="param-item">:${p}</span>`
                        ).join('');
                        paramContainer.style.display = 'block';
                    } else {
                        document.getElementById('paramExtractContainer').style.display = 'none';
                    }
                    
                    showToast('SQLæµ‹è¯•æ‰§è¡ŒæˆåŠŸ', 'success');
                    document.getElementById('sqlContent').classList.add('success');
                } else {
                    resultContainer.innerHTML = `
                        <div class="alert alert-error">
                            <span>âŒ</span>
                            <div>
                                <strong>SQLæ‰§è¡Œå¤±è´¥</strong><br>
                                é”™è¯¯ä¿¡æ¯: Table 'users' doesn't exist (ç¤ºä¾‹é”™è¯¯)
                            </div>
                        </div>
                    `;
                    resultContainer.style.display = 'block';
                    showToast('SQLæ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯­æ³•', 'error');
                }
                
                testBtn.disabled = false;
                testBtn.classList.remove('btn-loading');
                testBtn.textContent = 'â–¶ï¸ æµ‹è¯•æ‰§è¡Œ';
            }, 2000);
        }
        
        // ========================================
        // äº‹ä»¶å¤„ç†å‡½æ•°
        // ========================================
        
        /**
         * ä¸‹ä¸€æ­¥
         */
        function handleNext() {
            if (currentStep === 1) {
                if (validateStep1()) {
                    saveDraft();
                    switchStep(2);
                }
            } else if (currentStep === 2) {
                if (validateStep2()) {
                    saveDraft();
                    showToast('å³å°†è·³è½¬åˆ°Step 3-4é¡µé¢...', 'info');
                    setTimeout(() => {
                        window.location.href = 'report-create-step3-4.html';
                    }, 1500);
                }
            }
        }
        
        /**
         * ä¸Šä¸€æ­¥
         */
        function handlePrev() {
            if (currentStep > 1) {
                switchStep(currentStep - 1);
            }
        }
        
        /**
         * ä¿å­˜è‰ç¨¿
         */
        function handleSaveDraft() {
            if (currentStep === 1) {
                reportData.reportName = document.getElementById('reportName').value.trim();
                reportData.reportDesc = document.getElementById('reportDesc').value.trim();
            } else if (currentStep === 2) {
                reportData.sqlContent = document.getElementById('sqlContent').value.trim();
            }
            
            saveDraft();
            showToast('è‰ç¨¿å·²ä¿å­˜', 'success');
        }
        
        /**
         * å–æ¶ˆ
         */
        function handleCancel() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆåˆ›å»ºæŠ¥è¡¨å—ï¼Ÿæœªä¿å­˜çš„æ•°æ®å°†ä¸¢å¤±ã€‚')) {
                localStorage.removeItem('reportDraft');
                window.location.href = 'report-list.html';
            }
        }
        
        // ========================================
        // å­—ç¬¦è®¡æ•°
        // ========================================
        
        /**
         * æ›´æ–°å­—ç¬¦è®¡æ•°
         */
        function updateCharCounter(inputId, counterId, maxLength) {
            const input = document.getElementById(inputId);
            const counter = document.getElementById(counterId);
            const length = input.value.length;
            
            counter.textContent = `${length} / ${maxLength}`;
            
            if (length > maxLength * 0.9) {
                counter.classList.add('warning');
            } else {
                counter.classList.remove('warning');
            }
        }
        
        // ========================================
        // é¡µé¢åˆå§‹åŒ–
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // æ¢å¤è‰ç¨¿æ•°æ®
            if (reportData.reportName) {
                document.getElementById('reportName').value = reportData.reportName;
                updateCharCounter('reportName', 'reportNameCounter', 50);
            }
            
            if (reportData.reportDesc) {
                document.getElementById('reportDesc').value = reportData.reportDesc;
                updateCharCounter('reportDesc', 'reportDescCounter', 500);
            }
            
            if (reportData.sqlContent) {
                document.getElementById('sqlContent').value = reportData.sqlContent;
                updateCharCounter('sqlContent', 'sqlContentCounter', 10000);
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('reportName').addEventListener('input', function() {
                updateCharCounter('reportName', 'reportNameCounter', 50);
                this.classList.remove('error', 'success');
                document.getElementById('reportNameError').classList.remove('show');
            });
            
            document.getElementById('reportDesc').addEventListener('input', function() {
                updateCharCounter('reportDesc', 'reportDescCounter', 500);
            });
            
            document.getElementById('sqlContent').addEventListener('input', function() {
                updateCharCounter('sqlContent', 'sqlContentCounter', 10000);
                this.classList.remove('error', 'success');
                document.getElementById('sqlContentError').classList.remove('show');
                reportData.testExecuted = false;
                document.getElementById('testResultContainer').style.display = 'none';
                document.getElementById('paramExtractContainer').style.display = 'none';
            });
            
            document.getElementById('testExecuteBtn').addEventListener('click', testExecuteSQL);
            document.getElementById('nextBtn').addEventListener('click', handleNext);
            document.getElementById('prevBtn').addEventListener('click', handlePrev);
            document.getElementById('saveDraftBtn').addEventListener('click', handleSaveDraft);
            document.getElementById('cancelBtn').addEventListener('click', handleCancel);
            
            // è‡ªåŠ¨ä¿å­˜è‰ç¨¿ï¼ˆæ¯30ç§’ï¼‰
            setInterval(() => {
                if (currentStep === 1) {
                    reportData.reportName = document.getElementById('reportName').value.trim();
                    reportData.reportDesc = document.getElementById('reportDesc').value.trim();
                } else if (currentStep === 2) {
                    reportData.sqlContent = document.getElementById('sqlContent').value.trim();
                }
                saveDraft();
            }, 30000);
            
            // å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', function(e) {
                // Ctrl+S ä¿å­˜è‰ç¨¿
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    handleSaveDraft();
                }
                
                // Ctrl+Enter æµ‹è¯•æ‰§è¡Œï¼ˆStep 2ï¼‰
                if (currentStep === 2 && e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    testExecuteSQL();
                }
            });
        });
    </script>
</body>
</html>