# 程序员报表生成工具 - 核心功能优化说明 v2.0

> **文档版本**: v2.0
> **更新日期**: 2025-12-26
> **变更类型**: 功能边界调整
> **影响范围**: 设计端、用户端

---

## 📋 优化概述

根据业务需求调整，对三端架构的功能分配进行优化，明确设计端和用户端的职责边界。

### 🎯 核心变更

| 变更项 | 变更前 | 变更后 | 原因说明 |
|--------|--------|--------|----------|
| **报表预览** | 用户端功能 | **设计端功能** | 预览应作为设计阶段的测试验证功能，帮助设计者调试SQL和参数配置 |
| **报表查询** | （隐含在预览中） | **用户端功能（新增）** | 明确普通用户的核心使用场景：查询已授权的报表数据 |

---

## 🔄 功能重新分配详情

### 一、设计端（Designer）功能定义

#### 1.1 核心职责

为报表设计者（DESIGNER角色）提供报表创建、配置、测试、发布的完整工具链。

#### 1.2 功能清单

| 功能模块 | 功能描述 | 优先级 | 变更状态 |
|----------|----------|--------|----------|
| **SQL查询管理** | 输入SQL语句，定义参数占位符 | P0 | 无变更 |
| **报表模板设计** | 配置列属性（显示名称、列宽、格式化） | P0 | 无变更 |
| **报表预览** 🆕 | 测试执行SQL，预览查询结果，验证参数配置 | P0 | **从用户端移至设计端** |
| **角色授权** | 为报表分配角色权限（VIEWER/DESIGNER） | P0 | 无变更 |
| **报表列表管理** | 查看、编辑、删除已创建的报表 | P0 | 无变更 |

#### 1.3 报表预览功能详细说明

**使用场景**:
- 设计者创建报表后，需要验证SQL语法是否正确
- 验证参数占位符是否正确配置
- 验证查询结果的列配置（显示名称、格式化）是否符合预期
- 调试复杂SQL，确保数据准确性

**功能特性**:
- ✅ 支持多次测试执行（无限制次数）
- ✅ 实时输入参数值
- ✅ 分页展示结果（每页100条）
- ✅ 按列排序
- ✅ 显示执行时间和结果行数
- ⚠️ **仅设计者和管理员可用**（DESIGNER、ADMIN角色）

**技术实现**:
```javascript
// 设计端API路由
POST /api/designer/reports/:id/preview
```

**前端组件**:
- 参数输入表单（基于报表参数定义动态生成）
- 数据表格（Element UI Table）
- 分页组件
- 执行状态提示

---

### 二、用户端（Viewer）功能定义

#### 2.1 核心职责

为普通用户（VIEWER角色）提供报表查询、数据查看、Excel导出的完整使用流程。

#### 2.2 功能清单

| 功能模块 | 功能描述 | 优先级 | 变更状态 |
|----------|----------|--------|----------|
| **报表查询** 🆕 | 查看授权报表列表、选择报表、输入参数、执行查询 | P0 | **新增为用户端核心功能** |
| **数据展示** | 表格展示查询结果，支持分页和排序 | P0 | 无变更 |
| **Excel导出** | 将查询结果导出为Excel文件 | P0 | 无变更 |
| **权限过滤** | 仅显示已授权的报表 | P0 | 无变更 |

#### 2.3 报表查询功能详细说明

**使用场景**:
- 普通用户登录用户端，查看自己有权限的报表列表
- 选择某个报表，进入查询页面
- 输入查询参数（如日期范围、部门代码等）
- 执行查询，查看数据结果
- 导出Excel文件用于后续分析

**功能特性**:
- ✅ 权限过滤：仅显示已授权的报表
- ✅ 报表列表搜索
- ✅ 参数表单自动生成（基于报表参数定义）
- ✅ 参数必填校验
- ✅ 分页展示结果（每页100条）
- ✅ 按列排序
- ✅ 显示执行时间和结果行数
- ⚠️ **所有角色均可用**（VIEWER、DESIGNER、ADMIN）

**技术实现**:
```javascript
// 用户端API路由
GET  /api/viewer/reports              // 获取授权报表列表
GET  /api/viewer/reports/:id          // 获取报表详情
POST /api/viewer/reports/:id/query    // 执行查询
POST /api/viewer/reports/:id/export   // 导出Excel
```

**前端页面流程**:
```
报表列表页 → 选择报表 → 报表查询页 → 输入参数 → 执行查询 → 数据展示 → 导出Excel
```

---

## 🔍 设计端预览 vs 用户端查询 对比

| 对比维度 | 设计端预览 | 用户端查询 |
|----------|-----------|-----------|
| **使用角色** | DESIGNER、ADMIN | VIEWER、DESIGNER、ADMIN |
| **使用场景** | 报表设计阶段的测试验证 | 正式使用阶段的数据查询 |
| **权限控制** | 可查看所有自己创建的报表 | 只能查看已授权的报表 |
| **执行次数** | 无限制（调试用） | 无限制（业务查询） |
| **数据导出** | ❌ 不支持（测试阶段无需导出） | ✅ 支持（业务需求） |
| **参数输入** | ✅ 支持（测试用） | ✅ 支持（业务查询） |
| **分页排序** | ✅ 支持 | ✅ 支持 |
| **执行日志** | 可选记录（开发环境） | 必须记录（审计需求） |
| **性能要求** | 相对宽松（开发环境） | 严格（生产环境） |

---

## 📊 三端功能分布矩阵（更新后）

### 完整功能分布表

| 功能模块 | 管理端 | 设计端 | 用户端 | 说明 |
|----------|--------|--------|--------|------|
| **用户管理** | ✅ | ❌ | ❌ | 创建、编辑、禁用用户 |
| **角色分配** | ✅ | ❌ | ❌ | 为用户分配角色 |
| **SQL查询管理** | ❌ | ✅ | ❌ | 编写SQL、定义参数 |
| **报表模板设计** | ❌ | ✅ | ❌ | 配置列属性、格式化 |
| **报表预览** | ❌ | ✅ | ❌ | 测试执行SQL，验证配置 |
| **角色授权** | ❌ | ✅ | ❌ | 为报表分配角色权限 |
| **报表查询** | ✅ | ✅ | ✅ | 查看授权报表、执行查询 |
| **Excel导出** | ✅ | ✅ | ✅ | 导出查询结果 |
| **报表列表（全局）** | ✅ | ✅ | ❌ | 管理员和设计者可查看所有报表 |
| **报表列表（授权）** | ❌ | ❌ | ✅ | 普通用户仅查看已授权报表 |

### 角色权限矩阵（更新后）

| 角色 | 管理端 | 设计端 | 用户端 |
|------|--------|--------|--------|
| **ADMIN** | ✅ 用户管理<br>✅ 角色分配 | ✅ 报表设计<br>✅ 报表预览<br>✅ 角色授权 | ✅ 报表查询<br>✅ Excel导出 |
| **DESIGNER** | ❌ | ✅ 报表设计<br>✅ 报表预览<br>✅ 角色授权 | ✅ 报表查询（仅已授权）<br>✅ Excel导出 |
| **VIEWER** | ❌ | ❌ | ✅ 报表查询（仅已授权）<br>✅ Excel导出 |

---

## 🛠️ 技术实现建议

### 一、后端API设计

#### 1. 设计端API（新增预览功能）

```java
// 报表预览（设计端专用）
@PostMapping("/api/designer/reports/{id}/preview")
@PreAuthorize("hasAnyRole('ADMIN', 'DESIGNER')")
public ResponseEntity<ReportPreviewResult> previewReport(
    @PathVariable Long id,
    @RequestBody Map<String, Object> params
) {
    // 1. 验证报表是否属于当前用户创建
    // 2. 获取报表SQL模板
    // 3. 替换参数占位符
    // 4. 执行查询（使用只读账号）
    // 5. 返回查询结果（包含元数据：列名、类型、行数、执行时间）
    // 6. 记录预览日志（可选）
}

// 报表列表（设计端，显示所有自己创建的报表）
@GetMapping("/api/designer/reports")
@PreAuthorize("hasAnyRole('ADMIN', 'DESIGNER')")
public ResponseEntity<List<ReportDTO>> listMyReports() {
    // 返回当前用户创建的所有报表
}
```

#### 2. 用户端API（新增查询功能）

```java
// 报表列表（用户端，仅显示已授权报表）
@GetMapping("/api/viewer/reports")
@PreAuthorize("hasAnyRole('ADMIN', 'DESIGNER', 'VIEWER')")
public ResponseEntity<List<ReportDTO>> listAuthorizedReports() {
    // 1. 获取当前用户的角色
    // 2. 查询该角色授权的报表列表
    // 3. 返回报表基本信息（名称、描述、创建时间）
}

// 报表详情（用户端）
@GetMapping("/api/viewer/reports/{id}")
@PreAuthorize("hasAnyRole('ADMIN', 'DESIGNER', 'VIEWER')")
public ResponseEntity<ReportDetailDTO> getReportDetail(@PathVariable Long id) {
    // 1. 验证用户是否有权限访问该报表
    // 2. 返回报表详情（包含参数定义、列配置）
}

// 执行查询（用户端）
@PostMapping("/api/viewer/reports/{id}/query")
@PreAuthorize("hasAnyRole('ADMIN', 'DESIGNER', 'VIEWER')")
public ResponseEntity<QueryResult> queryReport(
    @PathVariable Long id,
    @RequestBody Map<String, Object> params
) {
    // 1. 验证用户是否有权限访问该报表
    // 2. 获取报表SQL模板
    // 3. 替换参数占位符
    // 4. 执行查询（使用只读账号）
    // 5. 返回查询结果
    // 6. **必须记录执行日志**（审计需求）
}

// 导出Excel（用户端）
@PostMapping("/api/viewer/reports/{id}/export")
@PreAuthorize("hasAnyRole('ADMIN', 'DESIGNER', 'VIEWER')")
public ResponseEntity<Resource> exportReport(
    @PathVariable Long id,
    @RequestBody Map<String, Object> params
) {
    // 1. 验证用户是否有权限访问该报表
    // 2. 执行查询（限制5000行）
    // 3. 生成Excel文件
    // 4. 返回文件流
    // 5. 记录导出日志
}
```

### 二、前端路由设计

#### 1. 设计端路由（Designer Frontend）

```javascript
// 设计端路由
const designerRoutes = [
  {
    path: '/designer/reports',
    name: 'ReportList',
    component: () => import('@/views/designer/ReportList.vue'),
    meta: { roles: ['ADMIN', 'DESIGNER'] }
  },
  {
    path: '/designer/reports/create',
    name: 'CreateReport',
    component: () => import('@/views/designer/CreateReport.vue'),
    meta: { roles: ['ADMIN', 'DESIGNER'] }
  },
  {
    path: '/designer/reports/:id/edit',
    name: 'EditReport',
    component: () => import('@/views/designer/EditReport.vue'),
    meta: { roles: ['ADMIN', 'DESIGNER'] }
  },
  {
    path: '/designer/reports/:id/preview',
    name: 'PreviewReport', // 🆕 报表预览页面
    component: () => import('@/views/designer/PreviewReport.vue'),
    meta: { roles: ['ADMIN', 'DESIGNER'] }
  }
]
```

#### 2. 用户端路由（Viewer Frontend）

```javascript
// 用户端路由
const viewerRoutes = [
  {
    path: '/viewer/reports',
    name: 'ViewerReportList', // 🆕 授权报表列表
    component: () => import('@/views/viewer/ReportList.vue'),
    meta: { roles: ['ADMIN', 'DESIGNER', 'VIEWER'] }
  },
  {
    path: '/viewer/reports/:id/query',
    name: 'QueryReport', // 🆕 报表查询页面
    component: () => import('@/views/viewer/QueryReport.vue'),
    meta: { roles: ['ADMIN', 'DESIGNER', 'VIEWER'] }
  }
]
```

### 三、前端组件设计

#### 1. 设计端预览组件（PreviewReport.vue）

```vue
<template>
  <div class="preview-report">
    <h2>{{ report.name }} - 测试预览</h2>
    
    <!-- 参数表单 -->
    <el-form :model="queryParams" ref="paramsForm">
      <el-form-item 
        v-for="param in report.parameters" 
        :key="param.name"
        :label="param.displayName"
        :required="param.required"
      >
        <el-input 
          v-if="param.type === 'STRING'"
          v-model="queryParams[param.name]"
        />
        <el-input-number 
          v-if="param.type === 'NUMBER'"
          v-model="queryParams[param.name]"
        />
        <el-date-picker 
          v-if="param.type === 'DATE'"
          v-model="queryParams[param.name]"
        />
      </el-form-item>
    </el-form>
    
    <!-- 执行按钮 -->
    <el-button type="primary" @click="executePreview">
      测试执行
    </el-button>
    
    <!-- 结果展示 -->
    <el-table :data="previewData" v-if="previewData.length > 0">
      <el-table-column 
        v-for="col in report.columns" 
        :key="col.fieldName"
        :prop="col.fieldName"
        :label="col.displayName"
        :width="col.width"
      />
    </el-table>
    
    <!-- 分页 -->
    <el-pagination
      :total="totalRows"
      :page-size="100"
      @current-change="handlePageChange"
    />
    
    <!-- 执行信息 -->
    <div class="execution-info">
      <span>执行时间: {{ executionTime }}ms</span>
      <span>结果行数: {{ totalRows }}</span>
    </div>
  </div>
</template>

<script>
export default {
  name: 'PreviewReport',
  data() {
    return {
      report: {},
      queryParams: {},
      previewData: [],
      totalRows: 0,
      executionTime: 0
    }
  },
  methods: {
    async executePreview() {
      const response = await this.$api.post(
        `/designer/reports/${this.$route.params.id}/preview`,
        this.queryParams
      )
      this.previewData = response.data.rows
      this.totalRows = response.data.totalRows
      this.executionTime = response.data.executionTime
    }
  }
}
</script>
```

#### 2. 用户端查询组件（QueryReport.vue）

```vue
<template>
  <div class="query-report">
    <h2>{{ report.name }}</h2>
    <p>{{ report.description }}</p>
    
    <!-- 参数表单（与预览组件类似） -->
    <el-form :model="queryParams" ref="paramsForm">
      <!-- 参数输入项 -->
    </el-form>
    
    <!-- 查询按钮 -->
    <el-button type="primary" @click="executeQuery">
      查询
    </el-button>
    
    <!-- 导出按钮 -->
    <el-button type="success" @click="exportExcel" v-if="queryData.length > 0">
      导出Excel
    </el-button>
    
    <!-- 结果展示 -->
    <el-table :data="queryData" v-if="queryData.length > 0">
      <!-- 表格列 -->
    </el-table>
    
    <!-- 分页 -->
    <el-pagination
      :total="totalRows"
      :page-size="100"
      @current-change="handlePageChange"
    />
  </div>
</template>

<script>
export default {
  name: 'QueryReport',
  data() {
    return {
      report: {},
      queryParams: {},
      queryData: [],
      totalRows: 0
    }
  },
  methods: {
    async executeQuery() {
      // 1. 参数校验
      if (!this.validateParams()) {
        return
      }
      
      // 2. 执行查询
      const response = await this.$api.post(
        `/viewer/reports/${this.$route.params.id}/query`,
        this.queryParams
      )
      this.queryData = response.data.rows
      this.totalRows = response.data.totalRows
    },
    
    async exportExcel() {
      // 1. 检查行数限制
      if (this.totalRows > 5000) {
        this.$message.warning('数据量过大，请添加筛选条件')
        return
      }
      
      // 2. 导出Excel
      const response = await this.$api.post(
        `/viewer/reports/${this.$route.params.id}/export`,
        this.queryParams,
        { responseType: 'blob' }
      )
      
      // 3. 下载文件
      const blob = new Blob([response.data])
      const link = document.createElement('a')
      link.href = window.URL.createObjectURL(blob)
      link.download = `${this.report.name}_${this.formatDate(new Date())}.xlsx`
      link.click()
    }
  }
}
</script>
```

---

## 🧪 验收标准更新

### 设计端新增验收点

#### 报表预览功能验收

- [ ] **预览入口**: 报表编辑页有"测试执行"或"预览"按钮
- [ ] **参数输入**: 显示参数输入表单，支持多种参数类型（字符串/数字/日期）
- [ ] **执行查询**: 点击执行后能正确显示查询结果
- [ ] **多次执行**: 可修改参数后重复执行，无限制次数
- [ ] **结果展示**: 表格展示数据，支持分页和排序
- [ ] **执行信息**: 显示执行时间和结果行数
- [ ] **错误处理**: SQL错误时友好提示错误信息
- [ ] **权限控制**: 仅ADMIN和DESIGNER角色可访问

### 用户端新增验收点

#### 报表查询功能验收

- [ ] **报表列表**: 用户端首页显示已授权的报表列表
- [ ] **列表搜索**: 可按报表名称搜索
- [ ] **报表详情**: 点击报表进入查询页，显示报表信息
- [ ] **参数表单**: 自动生成参数输入表单
- [ ] **参数校验**: 必填参数未填写时提示用户
- [ ] **执行查询**: 点击"查询"按钮后正确执行SQL
- [ ] **数据展示**: 表格展示数据，支持分页和排序
- [ ] **导出功能**: 可导出查询结果为Excel
- [ ] **权限过滤**: 仅显示已授权的报表，访问无权限报表时返回403
- [ ] **执行日志**: 后端记录所有查询和导出操作（审计需求）

---

## 📝 数据库变更（无需变更）

本次优化仅调整功能边界，**不涉及数据库结构变更**。

原有数据库设计已支持：
- 报表基本信息（`report`表）
- 报表参数定义（`report_parameter`表）
- 报表列配置（`report_column`表）
- 角色-报表权限关联（`role_report`表）
- 用户-角色关联（`user_role`表）

---

## 🚀 实施计划

### 阶段1: 后端API开发（3人日）

- [ ] 设计端预览API（1人日）
- [ ] 用户端查询API（1.5人日）
- [ ] 权限拦截器优化（0.5人日）

### 阶段2: 前端页面开发（4人日）

- [ ] 设计端预览页面（1.5人日）
- [ ] 用户端报表列表页面（1人日）
- [ ] 用户端查询页面（1.5人日）

### 阶段3: 联调测试（1人日）

- [ ] 设计端功能测试
- [ ] 用户端功能测试
- [ ] 权限控制测试

### 阶段4: 文档更新（0.5人日）

- [ ] 更新用户手册
- [ ] 更新API文档
- [ ] 更新验收清单

**总计**: 8.5人日（不超过原计划的16人日Buffer）

---

## 📚 相关文档

- [程序员报表生成工具-项目分析报告.md](../程序员报表生成工具-项目分析报告.md) - 已更新
- [需求澄清提示词模板_V2.0优化版.md](./需求澄清提示词模板_V2.0优化版.md)
- [报表生成工具需求.md](./报表生成工具需求.md) - 原始需求

---

## ✅ 变更审批

| 角色 | 姓名 | 审批状态 | 审批日期 |
|------|------|----------|----------|
| 需求方 | - | ✅ 已批准 | 2025-12-26 |
| 技术负责人 | - | 待审批 | - |
| 项目经理 | - | 待审批 | - |

---

**文档状态**: 已完成 ✅
