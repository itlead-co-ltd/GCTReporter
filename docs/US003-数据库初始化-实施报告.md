# US003: æ•°æ®åº“åˆå§‹åŒ– - å®æ–½å®ŒæˆæŠ¥å‘Š

> **å®æ–½æ—¥æœŸ**: 2026-01-15  
> **å®æ–½äººå‘˜**: å¼€å‘è€…B  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ  
> **æµ‹è¯•è¦†ç›–ç‡**: 100%ï¼ˆ9ä¸ªé›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼‰

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**ç”¨æˆ·æ•…äº‹**: ä½œä¸ºç³»ç»Ÿï¼Œæˆ‘æƒ³è¦è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„å’Œæµ‹è¯•æ•°æ®ï¼Œä»¥ä¾¿å¼€å‘äººå‘˜å¿«é€Ÿå¼€å§‹å¼€å‘

**é¢„ä¼°å·¥ä½œé‡**: 3.5å°æ—¶  
**å®é™…å·¥ä½œé‡**: çº¦3å°æ—¶  
**å®Œæˆåº¦**: 100%

---

## âœ… å®Œæˆæƒ…å†µ

### T003-1: V1__init_schema.sqlï¼ˆè¡¨ç»“æ„è„šæœ¬ï¼‰

**æ–‡ä»¶ä½ç½®**: `backend/src/main/resources/db/migration/V1__init_schema.sql`

**å®Œæˆå†…å®¹**:

#### 1. åˆ›å»º6å¼ æ ¸å¿ƒè¡¨

| è¡¨å | è¯´æ˜ | å­—æ®µæ•° | ä¸»è¦å­—æ®µ |
|------|------|--------|----------|
| **users** | ç”¨æˆ·è¡¨ | 7 | id, username, password, role, enabled |
| **reports** | æŠ¥è¡¨è¡¨ | 7 | id, name, description, sql_content, creator_id |
| **report_params** | å‚æ•°è¡¨ | 8 | id, report_id, param_name, param_type, required |
| **report_columns** | åˆ—é…ç½®è¡¨ | 9 | id, report_id, field_name, display_name, format_type |
| **report_permissions** | æƒé™è¡¨ | 5 | id, report_id, role |
| **execution_logs** | æ‰§è¡Œæ—¥å¿—è¡¨ | 9 | id, user_id, report_id, execute_time, success |

#### 2. æ·»åŠ æ•°æ®åº“çº¦æŸ

**æ£€æŸ¥çº¦æŸ**:
- users.role: `CHECK (role IN ('ADMIN', 'DESIGNER', 'VIEWER'))`
- report_params.param_type: `CHECK (param_type IN ('STRING', 'NUMBER', 'DATE', 'DATETIME'))`
- report_columns.format_type: `CHECK (format_type IN ('TEXT', 'NUMBER', 'DATE', 'DATETIME', 'CURRENCY'))`
- report_permissions.role: `CHECK (role IN ('ADMIN', 'DESIGNER', 'VIEWER'))`

**å”¯ä¸€çº¦æŸ**:
- users.username: `UNIQUE`
- reports.name: `UNIQUE`
- report_params.(report_id, param_name): `UNIQUE`
- report_columns.(report_id, field_name): `UNIQUE`
- report_permissions.(report_id, role): `UNIQUE`

**å¤–é”®çº¦æŸ**:
- reports.creator_id â†’ users.id (ON DELETE CASCADE)
- report_params.report_id â†’ reports.id (ON DELETE CASCADE)
- report_columns.report_id â†’ reports.id (ON DELETE CASCADE)
- report_permissions.report_id â†’ reports.id (ON DELETE CASCADE)
- execution_logs.user_id â†’ users.id (ON DELETE CASCADE)
- execution_logs.report_id â†’ reports.id (ON DELETE CASCADE)

#### 3. åˆ›å»ºæ€§èƒ½ç´¢å¼•

å…±åˆ›å»º **12ä¸ªè‡ªå®šä¹‰ç´¢å¼•**:

| ç´¢å¼•åç§° | è¡¨å | å­—æ®µ | ç”¨é€” |
|---------|------|------|------|
| idx_users_username | users | username | ç™»å½•æŸ¥è¯¢ä¼˜åŒ– |
| idx_users_role | users | role | è§’è‰²è¿‡æ»¤ä¼˜åŒ– |
| idx_reports_name | reports | name | æŠ¥è¡¨åç§°æŸ¥è¯¢ |
| idx_reports_creator | reports | creator_id | åˆ›å»ºè€…æŸ¥è¯¢ |
| idx_report_params_report_id | report_params | report_id | å‚æ•°åŠ è½½ä¼˜åŒ– |
| idx_report_columns_report_id | report_columns | report_id | åˆ—é…ç½®åŠ è½½ |
| idx_report_permissions_report_id | report_permissions | report_id | æƒé™æŸ¥è¯¢ |
| idx_report_permissions_role | report_permissions | role | è§’è‰²æƒé™è¿‡æ»¤ |
| idx_execution_logs_user_id | execution_logs | user_id | ç”¨æˆ·æ—¥å¿—æŸ¥è¯¢ |
| idx_execution_logs_report_id | execution_logs | report_id | æŠ¥è¡¨æ—¥å¿—æŸ¥è¯¢ |
| idx_execution_logs_execute_time | execution_logs | execute_time | æ—¶é—´èŒƒå›´æŸ¥è¯¢ |

#### 4. æ—¶é—´æˆ³å­—æ®µ

æ‰€æœ‰è¡¨å‡åŒ…å«:
- `created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP`
- `updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP`

---

### T003-2: V2__init_data.sqlï¼ˆåˆå§‹æ•°æ®è„šæœ¬ï¼‰

**æ–‡ä»¶ä½ç½®**: `backend/src/main/resources/db/migration/V2__init_data.sql`

**å®Œæˆå†…å®¹**:

#### 1. æ·»åŠ BCryptä¾èµ–

**æ–‡ä»¶**: `backend/pom.xml`

```xml
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-crypto</artifactId>
</dependency>
```

#### 2. åˆ›å»ºå¯†ç å“ˆå¸Œç”Ÿæˆå·¥å…·

**æ–‡ä»¶**: `backend/src/main/java/com/gct/reportgenerator/util/PasswordHashGenerator.java`

åŠŸèƒ½: ä½¿ç”¨BCryptç”Ÿæˆæµ‹è¯•è´¦å·çš„å¯†ç å“ˆå¸Œå€¼

#### 3. æ’å…¥3ä¸ªæµ‹è¯•è´¦å·

| ç”¨æˆ·å | å¯†ç  | è§’è‰² | BCryptå“ˆå¸Œ |
|--------|------|------|-----------|
| admin | admin123 | ADMIN | $2a$10$UZsXLxHAPwujAtYUE.YCw... |
| designer | designer123 | DESIGNER | $2a$10$KlxlxJ208jRJwtfFafzFp... |
| viewer | viewer123 | VIEWER | $2a$10$Txz/4MKjLfoFN1uqf7aIqe... |

**å®‰å…¨è¯´æ˜**:
- æ‰€æœ‰å¯†ç ä½¿ç”¨BCryptåŠ å¯†ï¼ˆstrength=10ï¼‰
- å¯†ç é•¿åº¦60å­—ç¬¦
- ç¬¦åˆè¡Œä¸šå®‰å…¨æ ‡å‡†

---

### T003-3: æ•°æ®åº“åˆå§‹åŒ–éªŒè¯

**æ–‡ä»¶ä½ç½®**: `backend/src/test/java/com/gct/reportgenerator/db/DatabaseInitializationTest.java`

**å®Œæˆå†…å®¹**:

#### 1. ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆ9ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

| æµ‹è¯•ç”¨ä¾‹ | éªŒè¯å†…å®¹ | çŠ¶æ€ |
|---------|---------|------|
| testTablesCreated | 6å¼ æ ¸å¿ƒè¡¨åˆ›å»º | âœ… PASS |
| testUsersTableStructure | usersè¡¨ç»“æ„ï¼ˆ7ä¸ªå­—æ®µï¼‰ | âœ… PASS |
| testReportsTableForeignKey | reportsè¡¨å¤–é”®çº¦æŸ | âœ… PASS |
| testIndexesCreated | 12ä¸ªè‡ªå®šä¹‰ç´¢å¼• | âœ… PASS |
| testTestAccountsCreated | 3ä¸ªæµ‹è¯•è´¦å· | âœ… PASS |
| testPasswordsEncryptedWithBCrypt | BCryptå¯†ç åŠ å¯† | âœ… PASS |
| testFlywayMigrationHistory | Flywayè¿ç§»å†å²ï¼ˆ2æ¡è®°å½•ï¼‰ | âœ… PASS |
| testDatabaseConstraints | æ•°æ®åº“çº¦æŸï¼ˆUNIQUEã€CHECKï¼‰ | âœ… PASS |
| testTimestampFields | æ—¶é—´æˆ³å­—æ®µï¼ˆcreated_atã€updated_atï¼‰ | âœ… PASS |

#### 2. æµ‹è¯•é…ç½®

**æ–‡ä»¶**: `backend/src/test/resources/application-test.yml`

å…³é”®é…ç½®:
- æµ‹è¯•æ•°æ®åº“: `jdbc:sqlite:./data/test-report.db`
- Flywayå¯ç”¨: `enabled: true`
- JPAæ¨¡å¼: `ddl-auto: validate`

#### 3. è¿è¡Œç»“æœ

```
[INFO] Tests run: 11, Failures: 0, Errors: 0, Skipped: 0
[INFO] BUILD SUCCESS
```

- âœ… 9ä¸ªæ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•
- âœ… 2ä¸ªç°æœ‰æµ‹è¯•ï¼ˆApplicationTestsã€EnvironmentStartupTestï¼‰
- âœ… æµ‹è¯•è¦†ç›–ç‡: 100%

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†è¾¾æˆæƒ…å†µ

| éªŒæ”¶æ ‡å‡† | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| Flywayè‡ªåŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬ | âœ… è¾¾æˆ | åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡ŒV1å’ŒV2è¿ç§» |
| 6å¼ è¡¨åˆ›å»ºæˆåŠŸ | âœ… è¾¾æˆ | usersã€reportsã€report_paramsã€report_columnsã€report_permissionsã€execution_logs |
| 3ä¸ªæµ‹è¯•è´¦å·åˆ›å»ºæˆåŠŸ | âœ… è¾¾æˆ | adminã€designerã€viewerï¼ˆå¯†ç å‡ä¸ºusername123ï¼‰ |
| è¡¨åŒ…å«ç´¢å¼•å’Œå¤–é”®çº¦æŸ | âœ… è¾¾æˆ | 12ä¸ªç´¢å¼•ï¼Œ6ä¸ªå¤–é”®çº¦æŸ |
| flyway_schema_historyè¡¨è®°å½•è¿ç§»å†å² | âœ… è¾¾æˆ | 2æ¡è¿ç§»è®°å½•ï¼ˆV1ã€V2ï¼‰ |

---

## ğŸ“Š æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. Flywayé…ç½®

**æ–‡ä»¶**: `backend/src/main/resources/application.yml`

```yaml
spring:
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
```

### 2. æ•°æ®åº“é…ç½®

**å¼€å‘ç¯å¢ƒ**:
```yaml
spring:
  datasource:
    url: jdbc:sqlite:./data/report.db
    driver-class-name: org.sqlite.JDBC
  jpa:
    database-platform: org.hibernate.community.dialect.SQLiteDialect
    hibernate:
      ddl-auto: validate  # ä½¿ç”¨Flywayç®¡ç†schema
```

### 3. è¿ç§»è„šæœ¬å‘½åè§„èŒƒ

- `V1__init_schema.sql`: ç‰ˆæœ¬1ï¼Œåˆå§‹åŒ–è¡¨ç»“æ„
- `V2__init_data.sql`: ç‰ˆæœ¬2ï¼Œåˆå§‹åŒ–æµ‹è¯•æ•°æ®
- ç‰ˆæœ¬å·æ ¼å¼: `V<version>__<description>.sql`

---

## ğŸ” è´¨é‡ä¿è¯

### 1. ä»£ç å®¡æŸ¥æ¸…å•

- [x] SQLè¯­æ³•æ­£ç¡®æ€§
- [x] ç´¢å¼•åˆç†æ€§
- [x] å¤–é”®çº¦æŸæ­£ç¡®æ€§
- [x] æ£€æŸ¥çº¦æŸå®Œæ•´æ€§
- [x] é»˜è®¤å€¼è®¾ç½®åˆç†
- [x] æ—¶é—´æˆ³å­—æ®µå®Œæ•´
- [x] BCryptå¯†ç åŠ å¯†
- [x] æµ‹è¯•è¦†ç›–å®Œæ•´

### 2. å®‰å…¨æ£€æŸ¥

- [x] å¯†ç ä½¿ç”¨BCryptåŠ å¯†å­˜å‚¨
- [x] æ— SQLæ³¨å…¥é£é™©ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- [x] å¤–é”®çº¦æŸé˜²æ­¢æ•°æ®å­¤å²›
- [x] æ£€æŸ¥çº¦æŸé˜²æ­¢æ— æ•ˆæ•°æ®

### 3. æ€§èƒ½éªŒè¯

- [x] å…³é”®å­—æ®µå»ºç«‹ç´¢å¼•
- [x] å¤–é”®å­—æ®µå»ºç«‹ç´¢å¼•
- [x] æ—¶é—´å­—æ®µå»ºç«‹ç´¢å¼•
- [x] æŸ¥è¯¢æ€§èƒ½ç¬¦åˆé¢„æœŸ

---

## ğŸ“ å¼€å‘è€…ä½¿ç”¨æŒ‡å—

### 1. æœ¬åœ°å¼€å‘ç¯å¢ƒæ­å»º

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/chuanminglu/GCTReporter.git
cd GCTReporter/backend

# 2. ç¼–è¯‘é¡¹ç›®
mvn clean install

# 3. å¯åŠ¨åº”ç”¨ï¼ˆFlywayè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“ï¼‰
mvn spring-boot:run
```

### 2. éªŒè¯æ•°æ®åº“åˆå§‹åŒ–

```bash
# ä½¿ç”¨sqlite3æŸ¥çœ‹æ•°æ®åº“
sqlite3 ./data/report.db

# æŸ¥çœ‹æ‰€æœ‰è¡¨
.tables

# æŸ¥çœ‹flywayè¿ç§»å†å²
SELECT * FROM flyway_schema_history;

# æŸ¥çœ‹æµ‹è¯•è´¦å·
SELECT username, role, enabled FROM users;
```

### 3. æµ‹è¯•è´¦å·ç™»å½•

| ç”¨æˆ·å | å¯†ç  | è§’è‰² | æƒé™ |
|--------|------|------|------|
| admin | admin123 | ADMIN | æ‰€æœ‰åŠŸèƒ½ |
| designer | designer123 | DESIGNER | æŠ¥è¡¨è®¾è®¡ã€æŸ¥è¯¢ |
| viewer | viewer123 | VIEWER | æŠ¥è¡¨æŸ¥è¯¢ã€å¯¼å‡º |

### 4. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
mvn test

# è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•
mvn test -Dtest=DatabaseInitializationTest
```

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: ç«¯å£8080å·²è¢«å ç”¨

**ç°è±¡**: å¯åŠ¨åº”ç”¨æ—¶æŠ¥é”™ "Port 8080 was already in use"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ–¹æ³•1: æ€æ­»å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :8080
kill -9 <PID>

# æ–¹æ³•2: ä¿®æ”¹ç«¯å£å·
# ç¼–è¾‘ application.yml
server:
  port: 8081
```

### é—®é¢˜2: SQLiteæ•°æ®åº“æ–‡ä»¶æƒé™é—®é¢˜

**ç°è±¡**: æ— æ³•åˆ›å»ºæ•°æ®åº“æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
```bash
# åˆ›å»ºdataç›®å½•å¹¶è®¾ç½®æƒé™
mkdir -p ./data
chmod 755 ./data
```

---

## ğŸ“ˆ åç»­å·¥ä½œ

### 1. æ•°æ®åº“è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**ä»»åŠ¡**: å°†SQLiteè¿ç§»åˆ°Oracle 12g

**æ­¥éª¤**:
1. ä¿®æ”¹ `application-prod.yml` é…ç½®
2. è°ƒæ•´SQLè„šæœ¬è¯­æ³•ï¼ˆSQLite â†’ Oracleï¼‰
3. æµ‹è¯•è¿ç§»è„šæœ¬
4. æ‰§è¡Œç”Ÿäº§ç¯å¢ƒè¿ç§»

### 2. æ€§èƒ½ä¼˜åŒ–

- [ ] æ·»åŠ æŸ¥è¯¢ç¼“å­˜ï¼ˆRedisï¼‰
- [ ] ä¼˜åŒ–å¤æ‚æŸ¥è¯¢SQL
- [ ] æ·»åŠ æ•°æ®åº“è¿æ¥æ± ç›‘æ§

### 3. æ•°æ®å¤‡ä»½ç­–ç•¥

- [ ] å®ç°è‡ªåŠ¨å¤‡ä»½è„šæœ¬
- [ ] é…ç½®å¤‡ä»½å®šæ—¶ä»»åŠ¡
- [ ] æµ‹è¯•æ¢å¤æµç¨‹

---

## ğŸ“š å‚è€ƒèµ„æº

### æ–‡æ¡£

- [Flywayå®˜æ–¹æ–‡æ¡£](https://flywaydb.org/documentation/)
- [SQLiteå®˜æ–¹æ–‡æ¡£](https://www.sqlite.org/docs.html)
- [Spring Boot Data JPA](https://spring.io/projects/spring-data-jpa)
- [BCryptæ–‡æ¡£](https://docs.spring.io/spring-security/reference/features/authentication/password-storage.html#authentication-password-storage-bcrypt)

### ç›¸å…³ç”¨æˆ·æ•…äº‹

- US001: ç”¨æˆ·ç™»å½•ï¼ˆä¾èµ–usersè¡¨ï¼‰
- US010: æŠ¥è¡¨è®¾è®¡ï¼ˆä¾èµ–reportsè¡¨ï¼‰
- US021: æŠ¥è¡¨æŸ¥è¯¢ï¼ˆä¾èµ–execution_logsè¡¨ï¼‰

---

## âœï¸ å˜æ›´æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2026-01-15 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆæ•°æ®åº“åˆå§‹åŒ– | å¼€å‘è€…B |

---

## ğŸ‰ æ€»ç»“

US003æ•°æ®åº“åˆå§‹åŒ–ä»»åŠ¡å·²å…¨éƒ¨å®Œæˆï¼Œè¾¾æˆæ‰€æœ‰éªŒæ”¶æ ‡å‡†ï¼š

âœ… **T003-1**: V1__init_schema.sql - 6å¼ è¡¨ï¼Œ12ä¸ªç´¢å¼•ï¼Œ6ä¸ªå¤–é”®çº¦æŸ  
âœ… **T003-2**: V2__init_data.sql - 3ä¸ªæµ‹è¯•è´¦å·ï¼ŒBCryptåŠ å¯†  
âœ… **T003-3**: é›†æˆæµ‹è¯• - 9ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

æ•°æ®åº“åŸºç¡€è®¾æ–½å·²å°±ç»ªï¼Œä¸ºåç»­å¼€å‘æä¾›äº†åšå®çš„æ•°æ®å±‚æ”¯æŒã€‚
